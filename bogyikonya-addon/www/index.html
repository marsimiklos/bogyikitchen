<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mohakonyha - Konyhai Nyilv√°ntart√≥ (Lok√°lis HA API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Egyedi mohaz√∂ld paletta defini√°l√°sa */
        :root {
            --color-moss-dark: #4D6232; /* M√©ly mohaz√∂ld - gombok, f√≥kusz */
            --color-moss-light: #78A059; /* Vil√°gos mohaz√∂ld - akcentus */
            --color-background: #F8F8F4; /* T√∂rtfeh√©r h√°tt√©r */
            --color-expired: #B22222; /* T≈±zpiros */
            --color-warning: #FFD700; /* Arany - Lej√°rat k√∂zeli */
        }
        .bg-moss-dark { background-color: var(--color-moss-dark); }
        .text-moss-dark { color: var(--color-moss-dark); }
        .border-moss-dark { border-color: var(--color-moss-dark); }
        .bg-moss-light { background-color: var(--color-moss-light); }
        .text-moss-light { color: var(--color-moss-light); }


        /* Scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb {
            background: var(--color-moss-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track { background: var(--color-background); }
        
        /* JAV√çTVA: Active tab sz√≠nek garant√°l√°sa */
        .active-tab {
            background-color: var(--color-moss-dark);
            color: white; /* Ez a l√©nyeg! */
        }
        .tab-btn {
            color: var(--color-moss-dark);
        }
        .tab-btn:not(.active-tab) {
            background-color: transparent;
        }
        .tab-btn:not(.active-tab):hover {
            background-color: #f1f1f1;
        }
        
        /* Prose st√≠lus a le√≠r√°sokhoz */
        .prose {
            color: #374151; /* text-gray-700 */
            line-height: 1.65;
        }
        .prose br {
            display: block;
            content: "";
            margin-top: 0.5em;
        }

        /* JAV√çTVA: Tag-ek hover st√≠lusa */
        .tag-btn-filter:hover {
            background-color: var(--color-moss-light) !important;
            color: white !important;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col font-sans">


    <div id="app" class="flex flex-col flex-grow max-w-4xl mx-auto w-full p-4 sm:p-6 lg:p-8">
       
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-moss-dark">Mohakonyha üåø</h1>
            <p id="auth-info" class="text-xs text-gray-500 mt-1">Helyi M√≥d (Lok√°lis API-t haszn√°l)...</p>
        </header>


        <div id="modal-container"></div>
        <div id="alert-container" class="fixed top-4 right-4 z-[100]"></div>


        <nav class="flex justify-between bg-white p-1 rounded-xl shadow-md mb-6 border border-moss-light">
            <button data-tab="preparedMeals" class="tab-btn active-tab flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200">K√©sz√©telek</button>
            <button data-tab="pantry" class="tab-btn flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200">Kamra</button>
            <button data-tab="shoppingList" class="tab-btn flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200">Bev√°s√°rl√≥lista</button>
            <button data-tab="recipes" class="tab-btn flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200">Receptesk√∂nyv</button>
        </nav>

        <div class="text-center mb-4 -mt-2">
            <a id="backup-link" href="#" download="mohakonyha_full_backup.zip" 
               class="text-sm text-gray-500 hover:text-moss-dark underline transition-colors">
                Teljes Rendszer Backup Let√∂lt√©se (Adatok + K√©pek, .zip)
            </a>
        </div>


        <main id="tab-content" class="flex-grow bg-white p-4 sm:p-6 rounded-xl shadow-md overflow-y-auto">
            <p class="text-center text-gray-500 py-10">Bet√∂lt√©s...</p>
        </main>


    </div>


<script type="module">
    // --- LOK√ÅLIS API ALAPBE√ÅLL√çT√ÅSOK (INGRESS JAV√çTVA) ---
    
    let ingressPath = window.location.pathname; 
    if (!ingressPath.endsWith('/')) {
        ingressPath += '/';
    }
    const LOCAL_API_BASE = `${ingressPath}api`;

    let userId = 'local_user';
    let isAuthReady = true; 
    let currentTab = 'preparedMeals';


    // Lok√°lis adatt√°rol√°s
    let state = {
        preparedMeals: [],
        pantry: [],
        shoppingList: [],
        recipes: [],
        pantryNames: new Set(), // Gyors keres√©shez, kisbet≈±s√≠tve
    };


    
    // Seg√©f√ºggv√©ny: API H√≠v√°sok kezel√©se 
    async function apiCall(endpoint, method = 'GET', data = null) {
        const url = `${LOCAL_API_BASE}/${endpoint}`;
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };


        if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);
            
            if (!response.ok) {
                throw new Error(`API hiba: ${response.status} ${response.statusText} a(z) ${url} c√≠men. Ellen≈ërizd a lok√°lis szervert!`);
            }
            
            if (response.status === 204) return null; 
            
            return await response.json();
        } catch (e) {
            console.error(`Kritikus hiba a lok√°lis API h√≠v√°sakor: ${url}`, e);
            showAlert('KRITIKUS HIBA: Nem siker√ºlt a helyi API-hoz csatlakozni. Ellen≈ërizd, hogy fut-e a szerver!', 'error');
            throw e; 
        }
    }

    const getLocalEndpoint = (collectionName) => {
        return collectionName; 
    };
    
    const serverTimestamp = () => new Date(); 


    // Seg√©f√ºggv√©ny: D√°tum form√°z√°sa
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        const date = timestamp instanceof Date ? timestamp : new Date(timestamp); 
        return date.toLocaleDateString('hu-HU', { year: 'numeric', month: 'short', day: 'numeric' });
    };


    // Seg√©df√ºggv√©ny: Alert √ºzenet megjelen√≠t√©se
    function showAlert(message, type = 'success') {
        const container = document.getElementById('alert-container');
       
        let color = type === 'error' ? 'bg-red-500' : 'bg-moss-light';

        const alertDiv = document.createElement('div');
        alertDiv.className = `p-4 mb-2 rounded-lg shadow-xl text-white max-w-sm ${color} transition-opacity duration-300 opacity-0`;
       
        alertDiv.innerHTML = `<span class="font-semibold">${message}</span>`;
       
        container.appendChild(alertDiv);
       
        setTimeout(() => alertDiv.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            alertDiv.addEventListener('transitionend', () => alertDiv.remove());
        }, 3000);
    }


    // --- ADATBET√ñLT√âS √âS FRISS√çT√âS ---
    async function setupLocalDataLoad(tabToRefresh = null) {
        try {
            const collections = ['preparedMeals', 'pantry', 'shoppingList', 'recipes'];
            for (const collection of collections) {
                if (tabToRefresh === collection || !tabToRefresh) {
                    const data = await apiCall(getLocalEndpoint(collection));
                    state[collection] = data || [];
                    if (collection === 'pantry') {
                         state.pantry = state[collection].map(item => ({ id: item.id, ...item, name: item.name.toLowerCase().trim() }));
                         state.pantryNames = new Set(state.pantry.map(item => item.name)); 
                    }
                }
            }
            
            // Friss√≠t√©s ut√°n renderel√©s
            if (currentTab === tabToRefresh || !tabToRefresh) {
                 switchTab(currentTab, false); // false: ne √°ll√≠tsa vissza a tabot, csak rendereljen
            }

        } catch (e) {
            // A hiba m√°r lekezelve az apiCall-ban
        }
    }


    // --- CRUD M≈±veletek ---


    // K√©sz√©telek (Prepared Meals)
    window.addPreparedMeal = async function(name, expiryDate, requiresSide) {
        try {
            await apiCall(getLocalEndpoint('preparedMeals'), 'POST', {
                name,
                expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null, 
                requiresSide,
                createdAt: serverTimestamp().toISOString()
            });
            showAlert('K√©sz√©tel sikeresen hozz√°adva a helyi API-n kereszt√ºl!');
            await setupLocalDataLoad('preparedMeals');
        } catch (e) { /* ... */ }
    }

    window.deletePreparedMeal = async function(id) {
        try {
            await apiCall(`${getLocalEndpoint('preparedMeals')}/${id}`, 'DELETE');
            showAlert('Elfogyasztva!');
            await setupLocalDataLoad('preparedMeals');
        } catch (e) { /* ... */ }
    }


    // Kamra (Pantry)
    window.addPantryItem = async function(name, expiryDate, shouldRestock, showAlertOnSuccess = true) {
        try {
            await apiCall(getLocalEndpoint('pantry'), 'POST', {
                name: name.trim(),
                // expiryDate m√°r null vagy valid string
                expiryDate: expiryDate,
                shouldRestock,
                createdAt: serverTimestamp().toISOString()
            });
            if (showAlertOnSuccess) {
                showAlert('Kamra t√©tel sikeresen hozz√°adva a helyi API-n kereszt√ºl!');
            }
            await setupLocalDataLoad('pantry');
        } catch (e) { /* ... */ }
    }

    window.markPantryItemUsedUp = async function(id, name, shouldRestock) {
        try {
            await apiCall(`${getLocalEndpoint('pantry')}/${id}`, 'DELETE');
            
            if (shouldRestock) {
                await apiCall(getLocalEndpoint('shoppingList'), 'POST', {
                    name,
                    isBought: false,
                    createdAt: serverTimestamp().toISOString(),
                    source: 'pantry_restock'
                });
                showAlert(`${name} elfogyott √©s automatikusan hozz√°adva a Bev√°s√°rl√≥list√°hoz!`);
                await setupLocalDataLoad('shoppingList');
            } else {
                showAlert(`${name} elfogyott!`);
            }
            
            await setupLocalDataLoad('pantry');
        } catch (e) { /* ... */ }
    }


    // Bev√°s√°rl√≥lista
    window.addShoppingListItem = async function(name) {
        try {
            await apiCall(getLocalEndpoint('shoppingList'), 'POST', {
                name: name.trim(),
                isBought: false,
                createdAt: serverTimestamp().toISOString(),
                source: 'manual'
            });
            showAlert(`${name} hozz√°adva a Bev√°s√°rl√≥list√°hoz!`);
            await setupLocalDataLoad('shoppingList');
        } catch (e) { /* ... */ }
    }
   
    window.deleteShoppingListItem = async function(id, showAlertOnSuccess = true) {
        try {
            await apiCall(`${getLocalEndpoint('shoppingList')}/${id}`, 'DELETE');
            if (showAlertOnSuccess) {
                showAlert('T√©tel t√∂r√∂lve a Bev√°s√°rl√≥list√°r√≥l!');
            }
            await setupLocalDataLoad('shoppingList');
        } catch (e) { /* ... */ }
    }


    // Receptesk√∂nyv (M√ìDOS√çTVA: √öj mez≈ëk)
    window.addRecipe = async function(name, ingredients, optionalIngredients, instructions, tags, imageFilename, difficulty) {
        try {
            await apiCall(getLocalEndpoint('recipes'), 'POST', {
                name: name.trim(),
                ingredients,
                optionalIngredients,
                instructions,
                tags,
                imageFilename, // √öJ
                difficulty,    // √öJ
                createdAt: serverTimestamp().toISOString()
            });
            showAlert(`${name} recept sikeresen hozz√°adva!`);
            await setupLocalDataLoad('recipes');
        } catch (e) { /* ... */ }
    }

    // Recept Friss√≠t√©se (M√ìDOS√çTVA: √öj mez≈ëk)
    window.updateRecipe = async function(id, name, ingredients, optionalIngredients, instructions, tags, imageFilename, difficulty) {
        try {
            await apiCall(`${getLocalEndpoint('recipes')}/${id}`, 'PUT', {
                id,
                name: name.trim(),
                ingredients,
                optionalIngredients,
                instructions,
                tags,
                imageFilename, // √öJ
                difficulty     // √öJ
            });
            showAlert(`${name} recept sikeresen friss√≠tve!`);
            await setupLocalDataLoad('recipes');
        } catch (e) {
            showAlert('Hiba a recept friss√≠t√©sekor!', 'error');
        }
    }


    window.deleteRecipe = async function(id) {
        // Figyelmeztet√©s a t√∂rl√©s el≈ëtt, hogy ne triggerelje a modal-t
        event.stopPropagation();
        if (confirm('Biztosan t√∂r√∂lni szeretn√©d ezt a receptet?')) {
            try {
                await apiCall(`${getLocalEndpoint('recipes')}/${id}`, 'DELETE');
                showAlert('Recept t√∂r√∂lve!');
                await setupLocalDataLoad('recipes');
            } catch (e) { /* ... */ }
        }
    }
    
    // --- UI/RENDER F√úGGV√âNYEK ---

    // D√°tum √°llapot jelz≈ë
    function getExpiryStatus(expiryDate) {
        if (!expiryDate) return { color: 'text-gray-500', label: 'N/A' };
        
        const date = new Date(expiryDate);
        const diffDays = Math.ceil((date.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return { color: 'bg-red-500 text-white', label: 'LEJ√ÅRT!' };
        if (diffDays <= 3) return { color: 'bg-yellow-400 text-gray-800', label: `Lej√°r: ${diffDays} nap` };
        return { color: 'text-gray-500', label: `${diffDays} nap` };
    }


    // Tab v√°lt√≥ logika
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            currentTab = button.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
            });
            button.classList.add('active-tab');
            switchTab(currentTab);
        });
    });


    function switchTab(tab, updateTabButtons = true) {
        const contentDiv = document.getElementById('tab-content');
        if (!isAuthReady) {
            contentDiv.innerHTML = '<p class="text-center text-gray-500 py-10">K√©rlek v√°rj, az alkalmaz√°s bet√∂lti a helyi m√≥dot...</p>';
            return;
        }
        
        // Friss√≠ti a gombokat, ha nem csak egy bels≈ë renderel√©s t√∂rt√©nik
        if (updateTabButtons) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active-tab');
                }
            });
        }


        switch (tab) {
            case 'preparedMeals': renderPreparedMeals(); break;
            case 'pantry': renderPantry(); break;
            case 'shoppingList': renderShoppingList(); break;
            case 'recipes': renderRecipes(); break;
        }
    }


    // --- 1. K√âSZ√âTELEK RENDEREL√âSE ---
    function renderPreparedMeals() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';
       
        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-moss-dark">Fagyaszt√≥/H≈±t≈ë Tartalom</h2>
                <button onclick="window.showPreparedMealModal()" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                    + √öj K√©sz√©tel
                </button>
            </div>
            <div id="prepared-meals-list" class="space-y-3">
                ${state.preparedMeals.length === 0 ? '<p class="text-center text-gray-500 py-10">Nincsenek r√∂gz√≠tett k√©sz√©telek. Add hozz√° az els≈ët!</p>' : ''}
            </div>
        `;
       
        const listDiv = document.getElementById('prepared-meals-list');
        const sortedMeals = [...state.preparedMeals].sort((a, b) => {
            const dateA = a.expiryDate ? new Date(a.expiryDate).getTime() : Infinity;
            const dateB = b.expiryDate ? new Date(b.expiryDate).getTime() : Infinity;
            return dateA - dateB;
        });


        sortedMeals.forEach(meal => {
            const status = getExpiryStatus(meal.expiryDate);
            listDiv.innerHTML += `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="flex-grow">
                        <p class="font-semibold text-moss-dark">${meal.name}</p>
                        <p class="text-xs text-gray-600">
                            Lej√°rati d√°tum: <span class="font-medium ${status.color === 'text-gray-500' ? 'text-gray-500' : 'px-2 py-0.5 rounded-full ' + status.color}">${formatDate(meal.expiryDate)} (${status.label})</span>
                        </p>
                        <p class="text-xs ${meal.requiresSide ? 'text-red-500' : 'text-moss-light'}">
                            K√∂ret sz√ºks√©ges: <span class="font-bold">${meal.requiresSide ? 'IGEN' : 'NEM'}</span>
                        </p>
                    </div>
                    <button onclick="window.deletePreparedMeal('${meal.id}')" class="ml-4 bg-moss-dark text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-moss-light transition-colors">
                        Elfogyasztva
                    </button>
                </div>
            `;
        });
    }
   
    // Modal a k√©sz√©telek bevitel√©hez (Glob√°lis)
    window.showPreparedMealModal = () => {
        if (!isAuthReady) {
            showAlert('Az alkalmaz√°s m√©g t√∂lt. K√©rlek v√°rj!', 'error');
            return;
        }
        const today = new Date().toISOString().split('T')[0];
        const modalHtml = `
            <div id="pm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 class="text-xl font-bold text-moss-dark mb-4">√öj K√©sz√©tel R√∂gz√≠t√©se</h3>
                    <form onsubmit="window.handlePreparedMealSubmit(event)">
                        <div class="mb-4">
                            <label for="pm-name" class="block text-sm font-medium text-gray-700">N√©v</label>
                            <input type="text" id="pm-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="mb-4">
                            <label for="pm-expiry" class="block text-sm font-medium text-gray-700">Lej√°rati D√°tum</label>
                            <input type="date" id="pm-expiry" value="${today}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="mb-6 flex items-center">
                            <input type="checkbox" id="pm-side" class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                            <label for="pm-side" class="ml-2 block text-sm text-gray-700">Kell hozz√° k√∂ret?</label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="window.closeModal('pm-modal')" class="px-4 py-2 text-sm font-semibold text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">M√©gsem</button>
                            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-moss-dark rounded-lg shadow hover:bg-moss-light transition-colors">Ment√©s</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;
    };


    // Modal submit handler (Glob√°lis)
    window.handlePreparedMealSubmit = (event) => {
        event.preventDefault();
        const name = document.getElementById('pm-name').value;
        const expiry = document.getElementById('pm-expiry').value;
        const side = document.getElementById('pm-side').checked;
        window.addPreparedMeal(name, expiry, side);
        window.closeModal('pm-modal');
    };
   
    // --- 2. KAMRA RENDEREL√âSE ---
    function renderPantry() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';


        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-moss-dark">Kamra Tartalom (Hozz√°val√≥k)</h2>
                <button onclick="window.showPantryModal()" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                    + √öj Kamra T√©tel
                </button>
            </div>
            <div id="pantry-list" class="space-y-3">
                ${state.pantry.length === 0 ? '<p class="text-center text-gray-500 py-10">A kamra √ºres. Kezdj√ºk a felt√∂lt√©st!</p>' : ''}
            </div>
        `;
       
        const listDiv = document.getElementById('pantry-list');
        const sortedPantry = [...state.pantry].sort((a, b) => {
            const dateA = a.expiryDate ? new Date(a.expiryDate).getTime() : Infinity;
            const dateB = b.expiryDate ? new Date(b.expiryDate).getTime() : Infinity;
            return dateA - dateB;
        });


        sortedPantry.forEach(item => {
            const nameCapitalized = item.name.charAt(0).toUpperCase() + item.name.slice(1);
            
            // M√ìDOS√çT√ÅS (2. k√©r√©s): Lej√°rat kezel√©se
            const expiryLabel = item.expiryDate ? formatDate(item.expiryDate) : 'N/A';
            const status = item.expiryDate ? getExpiryStatus(item.expiryDate) : { color: 'text-gray-500', label: 'Nem romland√≥' };
            
            listDiv.innerHTML += `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="flex-grow">
                        <p class="font-semibold text-moss-dark">${nameCapitalized}</p>
                        <p class="text-xs text-gray-600">
                            Lej√°rati d√°tum: <span class="font-medium ${status.color === 'text-gray-500' ? 'text-gray-500' : 'px-2 py-0.5 rounded-full ' + status.color}">${expiryLabel} (${status.label})</span>
                        </p>
                        <p class="text-xs ${item.shouldRestock ? 'text-moss-dark' : 'text-gray-500'}">
                            √öjrav√°s√°roland√≥ (Staple): <span class="font-bold">${item.shouldRestock ? 'IGEN' : 'NEM'}</span>
                        </p>
                    </div>
                    <button onclick="window.markPantryItemUsedUp('${item.id}', '${nameCapitalized}', ${item.shouldRestock})" class="ml-4 bg-red-500 text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-red-600 transition-colors">
                        Elfogyott
                    </button>
                </div>
            `;
        });
    }

    // √öJ (2. k√©r√©s): Seg√©df√ºggv√©ny a kamra lej√°rati d√°tum mez≈ë kezel√©s√©hez
    window.togglePantryExpiry = (isChecked) => {
        const expiryInput = document.getElementById('pantry-expiry');
        expiryInput.disabled = isChecked;
        if (isChecked) {
            expiryInput.value = ''; // T√∂rli az √©rt√©ket
            expiryInput.required = false; // Nem k√∂telez≈ë
        } else {
            expiryInput.value = new Date().toISOString().split('T')[0]; // Vissza√°ll√≠tja m√°ra
            expiryInput.required = true;
        }
    };

    // M√ìDOS√çTVA (2. k√©r√©s): Modal a kamra bevitel√©hez (Manu√°lis vagy Bev√°s√°rl√≥list√°r√≥l)
    window.showPantryModal = (shoppingItemId = null, prefilledName = '') => {
         if (!isAuthReady) {
            showAlert('Az alkalmaz√°s m√©g t√∂lt. K√©rlek v√°rj!', 'error');
            return;
        }
        const today = new Date().toISOString().split('T')[0];
        const modalHtml = `
            <div id="pantry-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 class="text-xl font-bold text-moss-dark mb-4">${shoppingItemId ? 'Megv√°s√°rolva - Kamr√°ba Ment√©s' : '√öj Kamra T√©tel R√∂gz√≠t√©se'}</h3>
                    <form onsubmit="window.handlePantrySubmit(event, '${shoppingItemId}', '${prefilledName}')">
                        <div class="mb-4">
                            <label for="pantry-name" class="block text-sm font-medium text-gray-700">N√©v</label>
                            <input type="text" id="pantry-name" value="${prefilledName}" ${prefilledName ? 'readonly' : 'required'} class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2 ${prefilledName ? 'bg-gray-100' : ''}">
                        </div>
                        <div class="mb-4">
                            <label for="pantry-expiry" class="block text-sm font-medium text-gray-700">Lej√°rati D√°tum</label>
                            <input type="date" id="pantry-expiry" value="${today}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        
                        <div class="mb-4 flex items-center">
                            <input type="checkbox" id="pantry-no-expiry" onchange="window.togglePantryExpiry(this.checked)" class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                            <label for="pantry-no-expiry" class="ml-2 block text-sm text-gray-700">Nincs lej√°rati d√°tuma (pl. liszt, s√≥)</label>
                        </div>

                        <div class="mb-6 flex items-center">
                            <input type="checkbox" id="pantry-restock" checked class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                            <label for="pantry-restock" class="ml-2 block text-sm text-gray-700">Alapvet≈ë √©lelmiszer (√öjrav√°s√°roland√≥)</label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="window.closeModal('pantry-modal')" class="px-4 py-2 text-sm font-semibold text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">M√©gsem</button>
                            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-moss-dark rounded-lg shadow hover:bg-moss-light transition-colors">Ment√©s √©s R√∂gz√≠t√©s</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;
    };


    // M√ìDOS√çTVA (2. k√©r√©s): Modal submit handler
    window.handlePantrySubmit = async function(event, shoppingItemId, prefilledName) {
        event.preventDefault();
        const name = prefilledName || document.getElementById('pantry-name').value;
        const expiryInput = document.getElementById('pantry-expiry');
        const isNonPerishable = document.getElementById('pantry-no-expiry').checked;
        
        // Ha nincs lej√°rati d√°tuma, null, egy√©bk√©nt az input √©rt√©ke
        const expiry = isNonPerishable ? null : expiryInput.value;
        
        const restock = document.getElementById('pantry-restock').checked;
       
        // Valid√°ci√≥: Ha romland√≥, de nincs d√°tum (b√°r a required v√©di)
        if (!isNonPerishable && !expiry) {
            showAlert('K√©rlek adj meg egy lej√°rati d√°tumot, vagy jel√∂ld be, hogy nincs neki.', 'error');
            return;
        }

        if (shoppingItemId && prefilledName) {
            await window.addPantryItem(name, expiry, restock, false);
            await window.deleteShoppingListItem(shoppingItemId, false); 
           
            showAlert(`Sikeresen megv√°s√°rolva √©s hozz√°adva a kamr√°hoz!`);
        } else {
            window.addPantryItem(name, expiry, restock);
        }
        window.closeModal('pantry-modal');
    };


    // --- 3. BEV√ÅS√ÅRL√ìLISTA RENDEREL√âSE ---
    function renderShoppingList() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';


        contentDiv.innerHTML = `
            <div class="flex flex-col mb-4 space-y-3">
                <h2 class="text-xl font-bold text-moss-dark">Bev√°s√°rl√≥lista</h2>
                <form onsubmit="window.handleNewShoppingItem(event)" class="flex space-x-2">
                    <input type="text" id="new-shopping-item" placeholder="√öj t√©tel hozz√°ad√°sa..." required class="flex-grow rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                    <button type="submit" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                        Hozz√°ad
                    </button>
                </form>
            </div>
            <div id="shopping-list-items" class="space-y-3">
                ${state.shoppingList.length === 0 ? '<p class="text-center text-gray-500 py-10">A bev√°s√°rl√≥lista √ºres! Vagy vedd meg a t√©teleket, vagy jel√∂lj el egy kamra alapanyagot elfogyottnak!</p>' : ''}
            </div>
        `;
       
        const listDiv = document.getElementById('shopping-list-items');
        state.shoppingList.forEach(item => {
            listDiv.innerHTML += `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200 justify-between">
                    <p class="font-medium text-gray-700 ${item.source === 'pantry_restock' ? 'italic' : ''}">${item.name}</p>
                    <div class="flex space-x-2">
                        <button onclick="window.showPantryModal('${item.id}', '${item.name}')" class="bg-moss-light text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-moss-dark transition-colors">
                            Megv√°s√°rolva
                        </button>
                        <button onclick="window.deleteShoppingListItem('${item.id}')" class="bg-gray-400 text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-gray-500 transition-colors">
                            T√∂r√∂l
                        </button>
                    </div>
                </div>
            `;
        });
    }


    // Bev√°s√°rl√≥ t√©tel kezel≈ë (Glob√°lis)
    window.handleNewShoppingItem = (event) => {
        event.preventDefault();
        const input = document.getElementById('new-shopping-item');
        window.addShoppingListItem(input.value);
        input.value = '';
    };


    // --- 4. RECEPTESK√ñNYV RENDEREL√âSE (JELENT≈êSEN √ÅTALAK√çTVA) ---
    
    // Glob√°lis sz≈±r≈ë √°llapot
    let recipeFilters = {
        hasAllIngredients: false,
        selectedTags: new Set(),
        allAvailableTags: new Set(),
    };
    
    // √öJ (5. k√©r√©s): Csillagok renderel√©se
    const renderStars = (difficulty) => {
        let stars = '';
        const d = parseInt(difficulty) || 0;
        for (let i = 1; i <= 5; i++) {
            stars += `<span class="text-lg ${i <= d ? 'text-yellow-500' : 'text-gray-300'}">‚òÖ</span>`;
        }
        return `<div class="flex" title="Bonyolults√°g: ${d}/5">${stars}</div>`;
    };

    // √öJ (4. k√©r√©s): K√©pfelt√∂lt√©s kezel≈ë (JAV√çTOTT √öTVONALLAL)
    window.uploadRecipeImage = async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const preview = document.getElementById('recipe-image-preview');
        const filenameInput = document.getElementById('recipe-image-filename');
        const uploadNotice = document.getElementById('upload-notice');
        
        preview.src = URL.createObjectURL(file); // Show local preview immediately
        preview.classList.remove('hidden');
        uploadNotice.textContent = 'K√©p felt√∂lt√©se...';

        const formData = new FormData();
        formData.append('file', file);

        try {
            // Az 'apiCall'-t nem haszn√°lhatjuk, mert az JSON-t k√ºld, nem FormData-t
            const response = await fetch(`${LOCAL_API_BASE}/upload-image`, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) throw new Error('K√©pfelt√∂lt√©s sikertelen');
            
            const result = await response.json();
            
            if (result.success && result.filename) {
                filenameInput.value = result.filename;
                // JAV√çTVA: A v√©gleges √∫tvonal az API-n kereszt√ºl
                preview.src = `${LOCAL_API_BASE}/images/${result.filename}`; 
                uploadNotice.textContent = 'K√©p sikeresen felt√∂ltve!';
                uploadNotice.classList.remove('text-red-500');
                uploadNotice.classList.add('text-moss-dark');
            } else {
                throw new Error(result.error || 'Ismeretlen hiba');
            }
        } catch (e) {
            console.error('K√©pfelt√∂lt√©si hiba:', e);
            uploadNotice.textContent = `Hiba: ${e.message}`;
            uploadNotice.classList.add('text-red-500');
            preview.src = ''; // Clear preview
            preview.classList.add('hidden');
            filenameInput.value = '';
        }
    };

    // √öJ (6. k√©r√©s): Recept R√©szletez≈ë Modal (JAV√çTOTT √öTVONALLAL)
    window.showRecipeDetailsModal = (id) => {
        const recipe = state.recipes.find(r => r.id === id);
        if (!recipe) return;

        // √öJ (1. k√©r√©s): Rich text (sort√∂r√©sek)
        const instructionsHtml = (recipe.instructions || '').replace(/\n/g, '<br>');

        const isIngredientInStock = (ingredientName) => {
            return state.pantryNames.has(ingredientName.toLowerCase().trim());
        };

        const allIngredientsHtml = [
            ...(recipe.ingredients || []).map(i => ({ name: i, optional: false })),
            ...(recipe.optionalIngredients || []).map(i => ({ name: i, optional: true }))
        ].map(item => {
            const stock = isIngredientInStock(item.name);
            const color = stock ? 'bg-moss-light' : 'bg-red-500';
            const status = stock ? 'K√©szleten' : 'Hi√°nyzik';
            return `
                <li class="flex items-center text-sm text-gray-700">
                    <span class="w-2 h-2 rounded-full mr-2 ${color} flex-shrink-0" title="${status}"></span>
                    ${item.name} ${item.optional ? '<span class="text-xs italic text-gray-500">(opcion√°lis)</span>' : ''}
                </li>
            `;
        }).join('');
        
        // K√©p placeholder
        const placeholderImg = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%220%200%20800%20400%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22800%22%20height%3D%22400%22%20fill%3D%22%23eeeeee%22%3E%3C%2Frect%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22sans-serif%22%20font-size%3D%2224px%22%20fill%3D%22%23999999%22%3ENincs%20k%C3%A9p%3C%2Ftext%3E%3C%2Fsvg%3E';
        // JAV√çTVA: A v√©gleges √∫tvonal az API-n kereszt√ºl
        const imgSrc = recipe.imageFilename ? `${LOCAL_API_BASE}/images/${recipe.imageFilename}` : placeholderImg;

        const modalHtml = `
            <div id="recipe-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl overflow-y-auto max-h-[90vh] relative">
                    <button onclick="window.closeModal('recipe-details-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>

                    <h3 class="text-2xl font-bold text-moss-dark mb-2">${recipe.name}</h3>
                    <div class="flex justify-between items-center mb-4">
                        ${renderStars(recipe.difficulty)}
                        <div class="flex flex-wrap gap-1">
                            ${(recipe.tags || []).map(tag => `<span class="text-xs bg-moss-dark/10 text-moss-dark px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
                        </div>
                    </div>
                    
                    <img src="${imgSrc}" alt="${recipe.name}" class="w-full h-64 object-cover rounded-lg mb-4 bg-gray-100">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Hozz√°val√≥k:</h4>
                            <ul class="list-none space-y-1 pl-0">
                                ${allIngredientsHtml}
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Elk√©sz√≠t√©si Javaslat:</h4>
                            <div class="text-sm text-gray-600 prose prose-sm">${instructionsHtml}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;
    };
    
    // Recept Szerkeszt√©s Kezd√©se (a r√©gi edit gomb)
    window.editRecipe = (id) => {
        // Meg√°ll√≠tjuk az esem√©ny propag√°ci√≥t, hogy ne ny√≠ljon meg a details modal
        event.stopPropagation();
        
        const recipe = state.recipes.find(r => r.id === id);
        if (recipe) {
            window.showRecipeModal(recipe); // A r√©gi "add/edit" modal-t h√≠vja
        } else {
            showAlert('A recept nem tal√°lhat√≥!', 'error');
        }
    };

    // √öJ (7. k√©r√©s): Keres√©s kezel≈ë
    window.handleRecipeSearch = () => {
        renderRecipes(); // √öjrarendereli a list√°t a keres≈ëmez≈ë aktu√°lis √©rt√©k√©vel
    };

    // M√ìDOS√çTVA: renderRecipes (teljesen √∫jratervezve)
    function renderRecipes() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';
       
        state.recipes.forEach(r => (r.tags || []).forEach(tag => recipeFilters.allAvailableTags.add(tag)));
       
        const isIngredientInStock = (ingredientName) => {
            return state.pantryNames.has(ingredientName.toLowerCase().trim());
        };

        const isRecipeCookable = (recipe) => {
            return (recipe.ingredients || []).every(isIngredientInStock);
        };


        // Tag sz≈±r≈ëk renderel√©se
        const tagFilterHtml = Array.from(recipeFilters.allAvailableTags).map(tag => {
            const isSelected = recipeFilters.selectedTags.has(tag);
            return `
                <button onclick="window.toggleTagFilter('${tag}')" class="text-xs px-3 py-1 rounded-full border transition-colors duration-200 tag-btn-filter ${
                    // JAV√çTVA: A kiv√°lasztott tag kapja a s√∂t√©tz√∂ld sz√≠nt, ami fel√ºl√≠rja a hovert
                    isSelected ? 'bg-moss-dark text-white border-moss-dark' : 'bg-white text-moss-dark border-moss-dark'
                }">
                    #${tag}
                </button>
            `;
        }).join('');

        // √öJ (7. k√©r√©s): Keres≈ëmez≈ë √©rt√©k√©nek kiolvas√°sa
        const searchTerm = document.getElementById('recipe-search-input') ? document.getElementById('recipe-search-input').value.toLowerCase() : '';

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-moss-dark">Receptesk√∂nyv </h2>
                <button onclick="window.showRecipeModal()" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                    + √öj Recept
                </button>
            </div>
           
            <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-moss-light/50">
                <h3 class="font-semibold text-moss-dark mb-3">Sz≈±r≈ëk:</h3>
               
                <div class="mb-4">
                    <input type="text" id="recipe-search-input" placeholder="Keres√©s a receptek nev√©ben..." onkeyup="window.handleRecipeSearch()" 
                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2" 
                           value="${searchTerm}">
                </div>

                <div class="flex items-center mb-4">
                    <input type="checkbox" id="filter-cookable" ${recipeFilters.hasAllIngredients ? 'checked' : ''} onchange="window.toggleCookableFilter(this.checked)" class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                    <label for="filter-cookable" class="ml-2 block text-sm font-medium text-gray-700">
                        Csak azokat, amikhez MINDEN van otthon (f≈ë hozz√°val√≥)
                    </label>
                </div>
               
                <div class="flex flex-wrap gap-2">
                    ${tagFilterHtml || '<p class="text-xs text-gray-500">Nincsenek c√≠mk√©k a receptekhez rendelve.</p>'}
                </div>
            </div>

            <div id="recipes-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
               
            </div>
        `;
       
        const listDiv = document.getElementById('recipes-list');
       
        // √öJ (3. k√©r√©s): ABC sorrend
        const sortedRecipes = [...state.recipes].sort((a, b) => a.name.localeCompare(b.name));

        let filteredRecipes = sortedRecipes.filter(recipe => {
            // √öJ (7. k√©r√©s): Keres√©s sz≈±r√©s
            if (searchTerm && !recipe.name.toLowerCase().includes(searchTerm)) {
                return false;
            }
            // R√©gi sz≈±r≈ëk
            if (recipeFilters.hasAllIngredients && !isRecipeCookable(recipe)) {
                return false;
            }
            if (recipeFilters.selectedTags.size > 0) {
                const recipeTags = new Set(recipe.tags || []);
                return Array.from(recipeFilters.selectedTags).every(tag => recipeTags.has(tag));
            }
            return true;
        });
       
        if (filteredRecipes.length === 0) {
            listDiv.innerHTML = '<p class="text-center text-gray-500 py-10 md:col-span-2">Nincs a sz≈±r≈ëknek megfelel≈ë recept.</p>';
        }

        // K√©p placeholder
        const placeholderImg = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%220%200%20800%20400%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Crect%20width%3D%22800%22%20height%3D%22400%22%20fill%3D%22%23eeeeee%22%3E%3C%2Frect%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22sans-serif%22%20font-size%3D%2224px%22%20fill%3D%22%23999999%22%3ENincs%20k%C3%A9p%3C%2Ftext%3E%3C%2Fsvg%3E';

        // √öJ (6. k√©r√©s): K√°rty√°k renderel√©se (JAV√çTOTT √öTVONALLAL)
        filteredRecipes.forEach(recipe => {
            // JAV√çTVA: A v√©gleges √∫tvonal az API-n kereszt√ºl
            const imgSrc = recipe.imageFilename ? `${LOCAL_API_BASE}/images/${recipe.imageFilename}` : placeholderImg;

            listDiv.innerHTML += `
                <div onclick="window.showRecipeDetailsModal('${recipe.id}')" 
                     class="bg-white p-4 rounded-xl shadow-lg border border-moss-light/30 transition-all duration-200 hover:shadow-xl hover:border-moss-light cursor-pointer flex flex-col justify-between">
                    
                    <div>
                        <img src="${imgSrc}" alt="${recipe.name}" class="w-full h-40 object-cover rounded-lg mb-3 bg-gray-100">
                        <h3 class="text-lg font-bold text-moss-dark mb-2">${recipe.name}</h3>
                    </div>
                    
                    <div class="flex justify-between items-center mt-2">
                        ${renderStars(recipe.difficulty)}
                        
                        <div class="flex space-x-1">
                            <button onclick="event.stopPropagation(); window.editRecipe('${recipe.id}')" title="Szerkeszt√©s" class="p-2 rounded-full text-moss-dark hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                    <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <button onclick="window.deleteRecipe('${recipe.id}')" title="T√∂rl√©s" class="p-2 rounded-full text-red-400 hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
    }


    // Recept sz≈±r≈ë (Glob√°lis)
    window.toggleCookableFilter = (checked) => {
        recipeFilters.hasAllIngredients = checked;
        renderRecipes();
    };


    // Recept tag sz≈±r≈ë (Glob√°lis)
    window.toggleTagFilter = (tag) => {
        if (recipeFilters.selectedTags.has(tag)) {
            recipeFilters.selectedTags.delete(tag);
        } else {
            recipeFilters.selectedTags.add(tag);
        }
        renderRecipes();
    };


    // M√ìDOS√çTVA (4. √©s 5. k√©r√©s): Recept bevitel modal (Glob√°lis) (JAV√çTOTT √öTVONALLAL)
    window.showRecipeModal = (recipe = null) => {
         if (!isAuthReady) {
            showAlert('Az alkalmaz√°s m√©g t√∂lt. K√©rlek v√°rj!', 'error');
            return;
        }
        
        const isEdit = recipe !== null;
        // Seg√©df√ºggv√©ny: t√∂mb stringg√© alak√≠t√°sa
        const formatList = (list) => Array.isArray(list) ? list.join(', ') : ''; 

        // √öj mez≈ëk alap√©rt√©kei
        // JAV√çTVA: A v√©gleges √∫tvonal az API-n kereszt√ºl
        const imgSrc = (isEdit && recipe.imageFilename) ? `${LOCAL_API_BASE}/images/${recipe.imageFilename}` : '';
        const difficultyValue = (isEdit && recipe.difficulty) ? recipe.difficulty : 1; // Alap√©rtelmezett 1

        const modalHtml = `
            <div id="recipe-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto max-h-[90vh]">
                    <h3 class="text-xl font-bold text-moss-dark mb-4">${isEdit ? 'Recept szerkeszt√©se' : '√öj Recept R√∂gz√≠t√©se'}</h3>
                    <form onsubmit="window.handleRecipeSubmit(event, '${isEdit ? recipe.id : ''}')">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700">K√©p</label>
                            <div class="mt-1 flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                                <img id="recipe-image-preview" src="${imgSrc}" class="h-20 w-20 object-cover rounded-lg ${imgSrc ? '' : 'hidden'} bg-gray-100" alt="Recept k√©p">
                                <input type="file" id="recipe-image-upload" accept="image/png, image/jpeg" onchange="window.uploadRecipeImage(event)" class="mt-2 sm:mt-0 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-moss-dark/10 file:text-moss-dark hover:file:bg-moss-dark/20">
                            </div>
                            <input type="hidden" id="recipe-image-filename" value="${isEdit ? (recipe.imageFilename || '') : ''}">
                            <p id="upload-notice" class="text-sm text-gray-500 mt-1"></p>
                        </div>

                        <div class="mb-4">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">N√©v</label>
                            <input type="text" id="recipe-name" value="${isEdit ? recipe.name : ''}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        
                        <div class="mb-4">
                            <label for="recipe-difficulty" class="block text-sm font-medium text-gray-700">Bonyolults√°g (1-5)</label>
                            <select id="recipe-difficulty" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                                <option value="1" ${difficultyValue == 1 ? 'selected' : ''}>1 - Nagyon k√∂nny≈±</option>
                                <option value="2" ${difficultyValue == 2 ? 'selected' : ''}>2 - K√∂nny≈±</option>
                                <option value="3" ${difficultyValue == 3 ? 'selected' : ''}>3 - K√∂zepes</option>
                                <option value="4" ${difficultyValue == 4 ? 'selected' : ''}>4 - Neh√©z</option>
                                <option value="5" ${difficultyValue == 5 ? 'selected' : ''}>5 - Nagyon neh√©z</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="recipe-ingredients" class="block text-sm font-medium text-gray-700">F≈ë Hozz√°val√≥k (Vessz≈ëvel elv√°lasztva)</label>
                            <textarea id="recipe-ingredients" required rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">${isEdit ? formatList(recipe.ingredients) : ''}</textarea>
                        </div>
                        <div class="mb-4">
                            <label for="recipe-optional" class="block text-sm font-medium text-gray-700">Opcion√°lis Hozz√°val√≥k (Vessz≈ëvel elv√°lasztva)</label>
                            <textarea id="recipe-optional" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">${isEdit ? formatList(recipe.optionalIngredients) : ''}</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="recipe-instructions" class="block text-sm font-medium text-gray-700">Elk√©sz√≠t√©si Javaslat</label>
                            <textarea id="recipe-instructions" required rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">${isEdit ? (recipe.instructions || '') : ''}</textarea>
                        </div>
                        
                        <div class="mb-6">
                            <label for="recipe-tags" class="block text-sm font-medium text-gray-700">Tagek (Vessz≈ëvel elv√°lasztva, pl. olasz, sajtos)</label>
                            <input type="text" id="recipe-tags" value="${isEdit ? formatList(recipe.tags) : ''}" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="window.closeModal('recipe-modal')" class="px-4 py-2 text-sm font-semibold text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">M√©gsem</button>
                            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-moss-dark rounded-lg shadow hover:bg-moss-light transition-colors">${isEdit ? 'Ment√©s' : 'R√∂gz√≠t√©s'}</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;

        // K√©p el≈ën√©zet√©nek friss√≠t√©se, ha nincs felt√∂lt√∂tt k√©p
        if (!imgSrc) {
            document.getElementById('recipe-image-preview').classList.add('hidden');
        } else {
             document.getElementById('recipe-image-preview').classList.remove('hidden');
        }
    };


    // Recept submit handler (Glob√°lis)
    window.handleRecipeSubmit = (event, recipeId = '') => { // MODOS√çTVA: recipeId
        event.preventDefault();
        const name = document.getElementById('recipe-name').value;
       
        // Hozz√°val√≥k feldolgoz√°sa (t√∂mb l√©trehoz√°sa √©s tiszt√≠t√°s)
        const ingredients = document.getElementById('recipe-ingredients').value
            .split(',')
            .map(i => i.trim())
            .filter(i => i);
           
        const optionalIngredients = document.getElementById('recipe-optional').value
            .split(',')
            .map(i => i.trim())
            .filter(i => i);
           
        // M√ìDOS√çTVA (1. k√©r√©s): Nyers sz√∂veg ment√©se, sort√∂r√©sekkel egy√ºtt
        const instructions = document.getElementById('recipe-instructions').value;
       
        // Tagek feldolgoz√°sa
        const tags = document.getElementById('recipe-tags').value
            .toLowerCase()
            .split(',')
            .map(t => t.trim())
            .filter(t => t);
        
        // √öJ (4. √©s 5. k√©r√©s): √öj mez≈ëk olvas√°sa
        const imageFilename = document.getElementById('recipe-image-filename').value;
        const difficulty = parseInt(document.getElementById('recipe-difficulty').value, 10);
            
        if (recipeId) {
            // Szerkeszt√©s (PUT)
            window.updateRecipe(recipeId, name, ingredients, optionalIngredients, instructions, tags, imageFilename, difficulty);
        } else {
            // √öj recept (POST)
            window.addRecipe(name, ingredients, optionalIngredients, instructions, tags, imageFilename, difficulty);
        }

        window.closeModal('recipe-modal');
    };


    // --- √Åltal√°nos Modal kezel≈ë (Glob√°lis) ---
    window.closeModal = (id) => {
        const modal = document.getElementById(id);
        if (modal) modal.remove();
        document.getElementById('modal-container').innerHTML = '';
    };
    
    // --- LOK√ÅLIS ALKALMAZ√ÅS IND√çT√ÅSA ---
    async function initLocalApp() {
        const apiPath = LOCAL_API_BASE;
        document.getElementById('auth-info').textContent = `Helyi M√≥d (API Base: ${apiPath})`;
       
        // JAV√çTVA: Backup link be√°ll√≠t√°sa
        document.getElementById('backup-link').href = `${LOCAL_API_BASE}/backup`;
       
        // Adatbet√∂lt√©s a helyi API-r√≥l
        await setupLocalDataLoad();
       
        // Els≈ë tab megjelen√≠t√©se
        switchTab(currentTab);
    }
    
    // Alkalmaz√°s ind√≠t√°sa a bet√∂lt√©s ut√°n
    window.addEventListener('load', () => {
        initLocalApp();
    });


</script>
</body>
</html>

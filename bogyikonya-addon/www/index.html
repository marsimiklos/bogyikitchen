<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bogyi Konyha - Konyhai Nyilv√°ntart√≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'moss-dark': '#4D584D', // S√∂t√©t moha
                        'moss-light': '#6F7F6F', // Vil√°gos moha
                        'cream': '#F3F4F6', // Kr√©msz√≠n
                        'leaf': '#85A661', // Lev√©lz√∂ld
                        'terracotta': '#CC7F6F', // Terrakotta (esetleg figyelmeztet√©sre)
                    }
                }
            }
        }
    </script>
    <style>
        /* Egyedi g√∂rget≈ës√°v a modern b√∂ng√©sz≈ëkh√∂z */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F3F4F6;
        }

        ::-webkit-scrollbar-thumb {
            background: #85A661;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6F7F6F;
        }

        /* Modal anim√°ci√≥ */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body class="bg-cream font-sans flex flex-col min-h-screen">

    <header class="bg-moss-dark text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold">Bogyi Konyha üçΩÔ∏è</h1>
            <div id="auth-info" class="text-sm bg-moss-light px-3 py-1 rounded-full">
                Helyi t√°rol√°s (Local JSON)
            </div>
        </div>
        
        <nav class="bg-moss-light shadow-inner">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-4">
                    <button id="tab-preparedMeals" onclick="switchTab('preparedMeals')" class="tab-button text-cream px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:border-leaf transition duration-150">K√©sz√©telek</button>
                    <button id="tab-pantry" onclick="switchTab('pantry')" class="tab-button text-cream px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:border-leaf transition duration-150">Kamra</button>
                    <button id="tab-shoppingList" onclick="switchTab('shoppingList')" class="tab-button text-cream px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:border-leaf transition duration-150">Bev√°s√°rl√≥lista</button>
                    <button id="tab-recipes" onclick="switchTab('recipes')" class="tab-button text-cream px-3 py-2 text-sm font-medium border-b-2 border-transparent hover:border-leaf transition duration-150">Receptesk√∂nyv</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 w-full">
        <div id="tab-content" class="min-h-[60vh] bg-white p-6 rounded-lg shadow-lg">
            </div>
    </main>

    <div id="alert-container" class="fixed top-2 right-2 z-50 space-y-2">
        </div>

    <div id="modal-container" class="fixed inset-0 z-40">
        </div>

<script type="module">
    // Nincs t√∂bb√© Firebase inicializ√°l√°s √©s auth.
    // A Flask szerver (app.py) kezeli a helyi adatt√°rol√°st.
    
    const BASE_API_URL = '/api/';
    let isAuthReady = true; // Mindig k√©sz, nincs hiteles√≠t√©s
    let currentTab = 'preparedMeals';
    let isInitialLoad = true;

    // Lok√°lis adatt√°rol√°s
    let state = {
        preparedMeals: [],
        pantry: [],
        shoppingList: [],
        recipes: [],
        pantryNames: new Set(), // Gyors keres√©shez, kisbet≈±s√≠tve
    };

    let recipeFilters = {
        isCookableFilterActive: false,
        activeTags: new Set(),
        allAvailableTags: new Set(),
        currentSearch: ''
    };
    
    // Auth info elt√°vol√≠t√°sa (nincs auth)
    document.addEventListener('DOMContentLoaded', () => {
        const authInfo = document.getElementById('auth-info');
        if (authInfo) {
            authInfo.textContent = 'Helyi t√°rol√°s (Local JSON)';
        }
    });

    // --- HELYI ADATKEZEL√âS (API H√çV√ÅSOK) ---

    // Seg√©df√ºggv√©ny: D√°tum form√°z√°sa
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        // A Flask ISO stringet ad vissza. Ezt dolgozzuk fel.
        const date = new Date(timestamp);
        return date.toLocaleDateString('hu-HU', { year: 'numeric', month: 'short', day: 'numeric' });
    };

    // Seg√©df√ºggv√©ny: API h√≠v√°s (CRUD)
    async function apiCall(method, collection, data = null, id = null) {
        let url = BASE_API_URL + collection;
        if (id) {
            url += '/' + id;
        }

        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            }
        };

        if (data) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`API hiba: ${response.status} ${response.statusText}`);
            }
            // A DELETE h√≠v√°s lehet, hogy nem ad vissza JSON-t (204 No Content), ez√©rt ellen≈ërizz√ºk
            if (response.status !== 204 && response.headers.get("content-length") !== "0") {
                return await response.json();
            }
            return { success: true };
        } catch (e) {
            console.error("Hiba az API h√≠v√°sban:", e);
            showAlert(`Hiba a kommunik√°ci√≥ban a helyi szerverrel: ${e.message}`, 'error');
            return { error: e.message };
        }
    }


    // --- F≈ê ADATBET√ñLT≈ê √âS RENDEREL≈ê F√úGGV√âNY ---
    
    async function loadAndRenderData() {
        if (!isAuthReady) return;

        try {
            const collections = ['preparedMeals', 'pantry', 'shoppingList', 'recipes'];
            
            const results = await Promise.all(collections.map(c => apiCall('GET', c)));
            
            if (results.some(r => r.error)) {
                throw new Error("Hiba az adatok lek√©rdez√©sekor.");
            }

            // Az id-k √©s a d√°tumok kezel√©se: a Python backend m√°r az id mez≈ëvel √©s ISO string d√°tumokkal adja vissza.
            state.preparedMeals = results[0];
            state.pantry = results[1].map(item => ({ 
                ...item, 
                // A Python backend m√°r kisbet≈±s√≠ti a nevet, de az id is fontos
                name: item.name.toLowerCase().trim() 
            }));
            state.shoppingList = results[2];
            state.recipes = results[3];

            // Gyors keres√©si k√©szlet friss√≠t√©se
            state.pantryNames = new Set(state.pantry.map(item => item.name));
            
            // Recept sz≈±r≈ëk tagjainak friss√≠t√©se, hogy a friss adatokon alapuljon
            recipeFilters.allAvailableTags = new Set();
            state.recipes.forEach(r => r.tags.forEach(tag => recipeFilters.allAvailableTags.add(tag)));

            if (isInitialLoad) {
                switchTab(currentTab);
                isInitialLoad = false;
            } else {
                // Csak a jelenlegi n√©zet friss√≠t√©se
                switch (currentTab) {
                    case 'preparedMeals': renderPreparedMeals(); break;
                    case 'pantry': renderPantry(); break;
                    case 'shoppingList': renderShoppingList(); break;
                    case 'recipes': renderRecipes(); break;
                }
            }
        } catch (e) {
            console.error("Hiba a teljes adatbet√∂lt√©skor:", e);
            const contentDiv = document.getElementById('tab-content');
            contentDiv.innerHTML = `<p class="text-center text-red-500 py-10">Kritikus hiba: Nem siker√ºlt a helyi API-hoz csatlakozni. K√©rlek ellen≈ërizd az add-on napl√≥it!</p>`;
        }
    }

    // Seg√©df√ºggv√©ny: Alert √ºzenet megjelen√≠t√©se
    function showAlert(message, type = 'success') {
        const container = document.getElementById('alert-container');
       
        let color;

        if (type === 'error') {
            color = 'bg-red-500';
        } else { // 'success'
            color = 'bg-moss-light';
        }

        const alertDiv = document.createElement('div');
        alertDiv.className = `p-4 mb-2 rounded-lg shadow-xl text-white max-w-sm ${color} transition-opacity duration-300 opacity-0`;
       
        alertDiv.innerHTML = `<span class="font-semibold">${message}</span>`;
       
        container.appendChild(alertDiv);
       
        // Anim√°ci√≥
        setTimeout(() => alertDiv.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            alertDiv.addEventListener('transitionend', () => alertDiv.remove());
        }, 3000);
    }

    // --- CRUD M≈±veletek (API H√çV√ÅSOK) ---

    // K√©sz√©telek (Prepared Meals)
    window.addPreparedMeal = async function(name, expiryDate, requiresSide) {
        const result = await apiCall('POST', 'preparedMeals', {
            name,
            // A d√°tumot ISO stringk√©nt k√ºldj√ºk
            expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null,
            requiresSide,
        });

        if (result.success) {
            showAlert('K√©sz√©tel sikeresen hozz√°adva!');
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }

    // K√©sz√©tel t√∂rl√©se/elfogyaszt√°sa
    window.deletePreparedMeal = async function(id) {
        const result = await apiCall('DELETE', 'preparedMeals', null, id);
        if (result.success) {
            showAlert('Elfogyasztva!');
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }

    // Kamra (Pantry)
    window.addPantryItem = async function(name, expiryDate, shouldRestock, showAlertOnSuccess = true) {
        const result = await apiCall('POST', 'pantry', {
            name: name.trim(),
            expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null,
            shouldRestock,
        });

        if (result.success) {
            if (showAlertOnSuccess) {
                showAlert('Kamra t√©tel sikeresen hozz√°adva!');
            }
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }

    // Kamra t√©tel elfogyott/t√∂rl√©se -> Bev√°s√°rl√≥list√°ra ker√ºl
    window.markPantryItemUsedUp = async function(id, name, shouldRestock) {
        // 1. Kamra t√©tel t√∂rl√©se
        const deleteResult = await apiCall('DELETE', 'pantry', null, id);

        if (deleteResult.success) {
            if (shouldRestock) {
                // 2. Bev√°s√°rl√≥list√°ra rak√°s
                const addResult = await apiCall('POST', 'shoppingList', {
                    name,
                    isBought: false,
                    source: 'pantry_restock'
                });

                if (addResult.success) {
                    showAlert(`${name} elfogyott √©s automatikusan hozz√°adva a Bev√°s√°rl√≥list√°hoz!`);
                    loadAndRenderData(); // Adatok friss√≠t√©se
                }
            } else {
                showAlert(`${name} elfogyott!`);
                loadAndRenderData(); // Adatok friss√≠t√©se
            }
        }
    }

    // Bev√°s√°rl√≥lista
    window.addShoppingListItem = async function(name) {
        const result = await apiCall('POST', 'shoppingList', {
            name: name.trim(),
            isBought: false,
            source: 'manual'
        });

        if (result.success) {
            showAlert(`${name} hozz√°adva a Bev√°s√°rl√≥list√°hoz!`);
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }
   
    window.deleteShoppingListItem = async function(id, showAlertOnSuccess = true) {
        const result = await apiCall('DELETE', 'shoppingList', null, id);
        
        if (result.success) {
            if (showAlertOnSuccess) {
                showAlert('T√©tel t√∂r√∂lve a Bev√°s√°rl√≥list√°r√≥l!');
            }
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }

    window.markShoppingItemBought = async function(id, name) {
        const result = await apiCall('DELETE', 'shoppingList', null, id);
        if (result.success) {
            // Mivel megvett√ºk, most hozz√°adjuk a kamr√°hoz
            // Haszn√°ljuk a m√°r l√©tez≈ë addPantryItem funkci√≥t. Nincs lej√°rati d√°tum √©s nincs sz√ºks√©g restock-ra, mivel most vett√ºk meg.
            // A false az utols√≥ param√©ter, ami jelzi, hogy ne jelenjen meg alert.
            window.addPantryItem(name, null, false, false); 
            showAlert(`${name} megv√°s√°rolva √©s hozz√°adva a Kamr√°hoz!`);
            // loadAndRenderData-t m√°r az addPantryItem h√≠vja
        }
    }

    // Receptesk√∂nyv
    window.addRecipe = async function(name, ingredients, optionalIngredients, instructions, tags) {
        const result = await apiCall('POST', 'recipes', {
            name: name.trim(),
            ingredients, 
            optionalIngredients, 
            instructions,
            tags, 
        });

        if (result.success) {
            showAlert(`${name} recept sikeresen hozz√°adva!`);
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }

    window.deleteRecipe = async function(id) {
        const result = await apiCall('DELETE', 'recipes', null, id);

        if (result.success) {
            showAlert('Recept t√∂r√∂lve!');
            loadAndRenderData(); // Adatok friss√≠t√©se
        }
    }

    // --- UI/RENDER F√úGGV√âNYEK ---

    function switchTab(tabName) {
        currentTab = tabName;
        const contentDiv = document.getElementById('tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');

        tabButtons.forEach(btn => {
            btn.classList.remove('border-leaf', 'font-bold');
            btn.classList.add('border-transparent');
        });

        document.getElementById(`tab-${tabName}`).classList.add('border-leaf', 'font-bold');

        contentDiv.innerHTML = '<div class="text-center py-10 text-moss-light">Adatok bet√∂lt√©se...</div>';

        switch (tabName) {
            case 'preparedMeals': renderPreparedMeals(); break;
            case 'pantry': renderPantry(); break;
            case 'shoppingList': renderShoppingList(); break;
            case 'recipes': renderRecipes(); break;
            default: contentDiv.innerHTML = '<p class="text-red-500">Hiba: Ismeretlen f√ºl.</p>';
        }
    }

    // D√°tum √°llapot jelz≈ë
    function getExpiryStatus(expiryDate) {
        if (!expiryDate) return { color: 'text-gray-500', label: 'N/A' };
        // Az ISO string konvert√°l√°sa Date objektumm√°, hogy a sz√°m√≠t√°s m≈±k√∂dj√∂n.
        const date = new Date(expiryDate);
        const diffDays = Math.ceil((date.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) return { color: 'bg-red-500 text-white', label: 'LEJ√ÅRT!' };
        if (diffDays <= 3) return { color: 'bg-yellow-400 text-gray-800', label: `Lej√°r: ${diffDays} nap` };
        return { color: 'text-gray-500', label: `${diffDays} nap` };
    }


    function renderPreparedMeals() {
        const contentDiv = document.getElementById('tab-content');
        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-moss-dark">K√©sz√©telek √©s marad√©kok (${state.preparedMeals.length} db)</h2>
                <button onclick="showPreparedMealModal()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                    + √öj K√©sz√©tel
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${state.preparedMeals.length === 0 ? '<p class="text-gray-500 col-span-full text-center">Nincs k√©sz√©tel a list√°ban.</p>' : state.preparedMeals.sort((a, b) => new Date(a.expiryDate) - new Date(b.expiryDate)).map(item => {
                    const status = getExpiryStatus(item.expiryDate);
                    return `
                        <div class="bg-cream p-4 rounded-lg shadow-md border-t-4 border-leaf flex flex-col justify-between">
                            <div>
                                <h3 class="text-xl font-bold text-moss-dark mb-2">${item.name}</h3>
                                <p class="text-sm text-gray-600 flex items-center mb-1">
                                    <span class="font-semibold mr-1">Lej√°rat:</span>
                                    <span class="px-2 py-0.5 text-xs rounded-full ${status.color}">${status.label}</span>
                                </p>
                                <p class="text-sm text-gray-600 mb-4">
                                    <span class="font-semibold">K√∂ret ig√©ny:</span> ${item.requiresSide ? 'Igen' : 'Nem'}
                                </p>
                            </div>
                            <button onclick="window.deletePreparedMeal('${item.id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm transition duration-150 mt-3">
                                Elfogyasztva / T√∂rl√©s
                            </button>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    function renderPantry() {
        const contentDiv = document.getElementById('tab-content');
        const now = Date.now();
        const expiredItems = state.pantry.filter(item => item.expiryDate && new Date(item.expiryDate).getTime() < now);
        const expiringSoonItems = state.pantry.filter(item => item.expiryDate && new Date(item.expiryDate).getTime() >= now && new Date(item.expiryDate).getTime() - now <= (3 * 24 * 60 * 60 * 1000));
        const otherItems = state.pantry.filter(item => expiredItems.indexOf(item) === -1 && expiringSoonItems.indexOf(item) === -1);

        const renderItems = (items, title, color, isExpired = false) => {
            if (items.length === 0) return '';
            return `
                <h3 class="text-xl font-semibold text-moss-dark mt-6 mb-3 border-b pb-1 text-${color}-600">${title} (${items.length} db)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${items.map(item => {
                        const status = getExpiryStatus(item.expiryDate);
                        return `
                            <div class="bg-cream p-3 rounded-lg shadow-md border-l-4 border-${color}-400 flex flex-col justify-between">
                                <div class="flex justify-between items-start">
                                    <h4 class="text-lg font-bold text-moss-dark">${item.name.charAt(0).toUpperCase() + item.name.slice(1)}</h4>
                                    ${item.shouldRestock ? '<span title="Ut√°np√≥tl√°s sz√ºks√©ges" class="text-leaf text-xl">üõí</span>' : ''}
                                </div>
                                <p class="text-xs text-gray-600 mb-2">
                                    <span class="font-semibold mr-1">Lej√°rati d√°tum:</span>
                                    <span class="px-2 py-0.5 text-xs rounded-full ${status.color}">${status.label}</span>
                                </p>
                                <button onclick="window.markPantryItemUsedUp('${item.id}', '${item.name}', ${item.shouldRestock})" class="bg-terracotta hover:bg-red-500 text-white font-bold py-1 px-3 rounded text-sm transition duration-150 mt-2">
                                    Elfogyott / T√∂rl√©s
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        };

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-moss-dark">Kamra nyilv√°ntart√≥ (${state.pantry.length} db)</h2>
                <button onclick="showPantryModal()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                    + √öj Kamra t√©tel
                </button>
            </div>
            ${renderItems(expiredItems, 'Lej√°rt T√©telek', 'red', true)}
            ${renderItems(expiringSoonItems, 'Hamarosan Lej√°r√≥ T√©telek (3 napon bel√ºl)', 'yellow')}
            ${renderItems(otherItems.sort((a, b) => {
                const dateA = a.expiryDate ? new Date(a.expiryDate) : new Date(8640000000000000); // Max Date for null
                const dateB = b.expiryDate ? new Date(b.expiryDate) : new Date(8640000000000000);
                return dateA - dateB;
            }), 'Egy√©b T√©telek', 'leaf')}
        `;
    }

    function renderShoppingList() {
        const contentDiv = document.getElementById('tab-content');
        
        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-moss-dark">Bev√°s√°rl√≥lista (${state.shoppingList.length} db)</h2>
            </div>
            
            <div class="mb-6 flex space-x-2">
                <input type="text" id="new-shopping-item" placeholder="√öj t√©tel hozz√°ad√°sa (pl. tej, keny√©r)" class="flex-grow p-2 border border-gray-300 rounded focus:ring-leaf focus:border-leaf">
                <button onclick="handleNewShoppingItem()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                    Hozz√°ad
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${state.shoppingList.length === 0 ? '<p class="text-gray-500 col-span-full text-center">Nincs t√©tel a bev√°s√°rl√≥list√°n.</p>' : state.shoppingList.map(item => `
                    <div class="bg-cream p-4 rounded-lg shadow-md border-l-4 border-leaf flex items-center justify-between">
                        <span class="text-lg font-medium text-moss-dark">${item.name.charAt(0).toUpperCase() + item.name.slice(1)}</span>
                        <div class="flex space-x-2">
                            <button onclick="window.markShoppingItemBought('${item.id}', '${item.name}')" title="Megv√°s√°rolva, mehet a kamr√°ba" class="text-leaf hover:text-moss-dark transition duration-150">
                                ‚úîÔ∏è
                            </button>
                            <button onclick="window.deleteShoppingListItem('${item.id}')" title="T√∂rl√©s" class="text-red-500 hover:text-red-700 transition duration-150">
                                ‚ùå
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderRecipes() {
        const contentDiv = document.getElementById('tab-content');
        
        const filterPills = Array.from(recipeFilters.allAvailableTags).sort().map(tag => {
            const isActive = recipeFilters.activeTags.has(tag);
            return `
                <button onclick="toggleTagFilter('${tag}')" class="tag-pill ${isActive ? 'bg-leaf text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-3 py-1 text-sm rounded-full transition duration-150 mr-2 mb-2">
                    ${tag}
                </button>
            `;
        }).join('');

        const filteredRecipes = state.recipes.filter(recipe => {
            // 1. Tag sz≈±r√©s
            if (recipeFilters.activeTags.size > 0) {
                const hasAllTags = Array.from(recipeFilters.activeTags).every(tag => recipe.tags.includes(tag));
                if (!hasAllTags) return false;
            }

            // 2. 'F≈ëzhet≈ë' sz≈±r√©s
            if (recipeFilters.isCookableFilterActive) {
                // Ellen≈ërizz√ºk, hogy minden k√∂telez≈ë √∂sszetev≈ë megvan-e a kamr√°ban
                const isCookable = recipe.ingredients.every(ing => state.pantryNames.has(ing.toLowerCase().trim()));
                if (!isCookable) return false;
            }

            // 3. Keres√©s
            if (recipeFilters.currentSearch) {
                const searchLower = recipeFilters.currentSearch.toLowerCase();
                if (!recipe.name.toLowerCase().includes(searchLower) && 
                    !recipe.ingredients.some(ing => ing.toLowerCase().includes(searchLower)) &&
                    !recipe.tags.some(tag => tag.toLowerCase().includes(searchLower))) {
                    return false;
                }
            }

            return true;
        });

        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-moss-dark">Receptesk√∂nyv (${filteredRecipes.length} / ${state.recipes.length} recept)</h2>
                <button onclick="showRecipeModal()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                    + √öj Recept
                </button>
            </div>

            <div class="mb-6 bg-cream p-4 rounded-lg shadow-inner">
                <div class="flex space-x-4 mb-4 items-center">
                    <input type="text" id="recipe-search" placeholder="Keres√©s n√©v, √∂sszetev≈ë, vagy tag szerint..." value="${recipeFilters.currentSearch}" 
                           oninput="recipeFilters.currentSearch = this.value; renderRecipes();" 
                           class="flex-grow p-2 border border-gray-300 rounded focus:ring-leaf focus:border-leaf">
                    
                    <button onclick="toggleCookableFilter()" 
                            class="${recipeFilters.isCookableFilterActive ? 'bg-leaf' : 'bg-gray-300'} hover:opacity-80 text-white font-bold py-2 px-4 rounded transition duration-150 flex items-center">
                        ${recipeFilters.isCookableFilterActive ? '‚úÖ Csak a F≈ëzhet≈ëek' : 'F≈ëzhet≈ëek sz≈±r√©se'}
                    </button>
                </div>
                
                <div class="border-t pt-3 mt-3">
                    <p class="text-sm font-semibold text-moss-dark mb-2">Tag-ek sz≈±r√©se:</p>
                    ${filterPills || '<p class="text-xs text-gray-500">Nincs el√©rhet≈ë tag.</p>'}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${filteredRecipes.length === 0 ? '<p class="text-gray-500 col-span-full text-center">Nincs a sz≈±r≈ëknek megfelel≈ë recept.</p>' : filteredRecipes.map(recipe => {
                    // K√ºl√∂n ellen≈ërz√©s a recept k√°rty√°n
                    const isCookable = recipe.ingredients.every(ing => state.pantryNames.has(ing.toLowerCase().trim()));
                    const cookableIndicator = isCookable ? 
                        '<span class="text-leaf font-bold">‚úÖ F≈ëzhet≈ë (Megvan minden)</span>' : 
                        '<span class="text-terracotta font-bold">‚ùå Hi√°nyos (V√°s√°rolni kell)</span>';

                    return `
                        <div class="bg-cream p-5 rounded-lg shadow-md border-t-4 ${isCookable ? 'border-leaf' : 'border-terracotta'} flex flex-col">
                            <h3 class="text-2xl font-bold text-moss-dark mb-2">${recipe.name}</h3>
                            <p class="text-sm mb-3">${cookableIndicator}</p>
                            
                            <div class="mb-3">
                                <p class="font-semibold text-moss-dark">√ñsszetev≈ëk:</p>
                                <ul class="list-disc list-inside text-gray-600 text-sm pl-2 max-h-20 overflow-y-auto">
                                    ${recipe.ingredients.map(ing => {
                                        const hasIt = state.pantryNames.has(ing.toLowerCase().trim());
                                        return `<li class="${hasIt ? 'text-green-600' : 'text-red-500'}">${ing}</li>`;
                                    }).join('')}
                                    ${recipe.optionalIngredients && recipe.optionalIngredients.length > 0 ? 
                                        recipe.optionalIngredients.map(ing => `<li class="text-gray-500 italic">(${ing} - opcion√°lis)</li>`).join('') : ''}
                                </ul>
                            </div>
                            
                            <div class="mb-3 flex-grow">
                                <p class="font-semibold text-moss-dark">Utas√≠t√°s:</p>
                                <p class="text-gray-600 text-sm overflow-hidden h-12">${recipe.instructions.substring(0, 100)}${recipe.instructions.length > 100 ? '...' : ''}</p>
                            </div>

                            <div class="mt-2">
                                ${recipe.tags.map(tag => `<span class="bg-moss-light text-white px-2 py-0.5 text-xs rounded-full mr-1">${tag}</span>`).join('')}
                            </div>
                            
                            <div class="flex justify-between mt-4">
                                <button onclick="showRecipeModal('${recipe.id}')" class="bg-moss-light hover:bg-leaf text-white font-bold py-1 px-3 rounded text-sm transition duration-150">
                                    Megtekint / Szerkeszt
                                </button>
                                <button onclick="window.deleteRecipe('${recipe.id}')" class="text-red-500 hover:text-red-700 font-bold py-1 px-3 text-sm transition duration-150">
                                    T√∂rl√©s
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    // --- MODAL KEZEL≈ê F√úGGV√âNYEK ---

    window.closeModal = (id) => {
        const modal = document.getElementById(id);
        if (modal) modal.remove();
        document.getElementById('modal-container').innerHTML = '';
    };
    
    // √Åltal√°nos modal alap
    function createModal(id, title, bodyHtml, footerHtml = '', sizeClass = 'max-w-xl') {
        const container = document.getElementById('modal-container');
        const modal = document.createElement('div');
        modal.id = id;
        modal.className = 'modal-enter-from fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 transition-opacity duration-300';
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-2xl ${sizeClass} w-full overflow-hidden" onclick="event.stopPropagation()">
                <div class="bg-moss-dark text-white p-4 flex justify-between items-center">
                    <h3 class="text-xl font-bold">${title}</h3>
                    <button onclick="window.closeModal('${id}')" class="text-white hover:text-cream text-2xl font-light leading-none">
                        &times;
                    </button>
                </div>
                <div class="p-6 max-h-[80vh] overflow-y-auto">
                    ${bodyHtml}
                </div>
                ${footerHtml ? `<div class="bg-gray-100 p-4 border-t flex justify-end">${footerHtml}</div>` : ''}
            </div>
        `;
        container.appendChild(modal);
        // Aktiv√°lja a modal-enter-active √°llapotot a be√∫sz√°s anim√°ci√≥hoz
        setTimeout(() => modal.classList.remove('modal-enter-from'), 10);
    }

    // K√©sz√©tel modal
    window.showPreparedMealModal = function() {
        const modalId = 'prepared-meal-modal';
        const body = `
            <div class="space-y-4">
                <input type="text" id="meal-name" placeholder="√âtel neve (pl. R√°ntott h√∫s, Guly√°s)" class="w-full p-2 border border-gray-300 rounded">
                <div>
                    <label for="expiry-date" class="block text-sm font-medium text-gray-700 mb-1">Elfogyasztand√≥ (Lej√°rati D√°tum):</label>
                    <input type="date" id="expiry-date" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="requires-side" class="h-4 w-4 text-leaf border-gray-300 rounded">
                    <label for="requires-side" class="ml-2 block text-sm text-gray-900">K√∂retet ig√©nyel (pl. burgonya, rizs)</label>
                </div>
            </div>
        `;
        const footer = `
            <button onclick="handlePreparedMealSubmit()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                Ment√©s
            </button>
        `;
        createModal(modalId, '√öj K√©sz√©tel Hozz√°ad√°sa', body, footer);
    }

    window.handlePreparedMealSubmit = function() {
        const name = document.getElementById('meal-name').value.trim();
        const expiryDate = document.getElementById('expiry-date').value;
        const requiresSide = document.getElementById('requires-side').checked;

        if (!name) {
            showAlert('Az √©tel neve k√∂telez≈ë!', 'error');
            return;
        }

        window.addPreparedMeal(name, expiryDate, requiresSide);
        window.closeModal('prepared-meal-modal');
    }

    // Kamra modal
    window.showPantryModal = function() {
        const modalId = 'pantry-modal';
        const body = `
            <div class="space-y-4">
                <input type="text" id="pantry-name" placeholder="T√©tel neve (pl. Tej, Liszt, Vaj)" class="w-full p-2 border border-gray-300 rounded">
                <div>
                    <label for="pantry-expiry-date" class="block text-sm font-medium text-gray-700 mb-1">Lej√°rati D√°tum (opcion√°lis):</label>
                    <input type="date" id="pantry-expiry-date" class="w-full p-2 border border-gray-300 rounded">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="pantry-restock" class="h-4 w-4 text-leaf border-gray-300 rounded" checked>
                    <label for="pantry-restock" class="ml-2 block text-sm text-gray-900">Ut√°np√≥tl√°s sz√ºks√©ges, ha elfogy (automatikusan a Bev√°s√°rl√≥list√°ra ker√ºl)</label>
                </div>
            </div>
        `;
        const footer = `
            <button onclick="handlePantrySubmit()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                Ment√©s
            </button>
        `;
        createModal(modalId, '√öj Kamra T√©tel Hozz√°ad√°sa', body, footer);
    }

    window.handlePantrySubmit = function() {
        const name = document.getElementById('pantry-name').value.trim();
        const expiryDate = document.getElementById('pantry-expiry-date').value;
        const shouldRestock = document.getElementById('pantry-restock').checked;

        if (!name) {
            showAlert('A t√©tel neve k√∂telez≈ë!', 'error');
            return;
        }

        window.addPantryItem(name, expiryDate, shouldRestock);
        window.closeModal('pantry-modal');
    }

    // Bev√°s√°rl√≥lista
    window.handleNewShoppingItem = function() {
        const input = document.getElementById('new-shopping-item');
        const name = input.value.trim();

        if (!name) {
            showAlert('K√©rlek, adj meg egy t√©telt!', 'error');
            return;
        }

        window.addShoppingListItem(name);
        input.value = ''; // ≈∞rlap t√∂rl√©se
    }

    // Recept modal
    window.showRecipeModal = function(recipeId = null) {
        const modalId = 'recipe-modal';
        let recipe = {
            id: null,
            name: '',
            ingredients: '',
            optionalIngredients: '',
            instructions: '',
            tags: ''
        };
        let title = '√öj Recept Hozz√°ad√°sa';

        if (recipeId) {
            recipe = state.recipes.find(r => r.id === recipeId);
            if (recipe) {
                title = `Recept: ${recipe.name}`;
                recipe.ingredients = Array.isArray(recipe.ingredients) ? recipe.ingredients.join(', ') : recipe.ingredients;
                recipe.optionalIngredients = Array.isArray(recipe.optionalIngredients) ? recipe.optionalIngredients.join(', ') : recipe.optionalIngredients;
                recipe.tags = Array.isArray(recipe.tags) ? recipe.tags.join(', ') : recipe.tags;
            }
        }

        const body = `
            <input type="hidden" id="recipe-id" value="${recipe.id || ''}">
            <div class="space-y-4">
                <input type="text" id="recipe-name" placeholder="Recept neve" value="${recipe.name}" class="w-full p-2 border border-gray-300 rounded text-xl font-bold">
                
                <div class="border-t pt-4">
                    <label for="recipe-ingredients" class="block text-sm font-medium text-moss-dark mb-1">K√∂telez≈ë √∂sszetev≈ëk (vessz≈ëvel elv√°lasztva):</label>
                    <textarea id="recipe-ingredients" rows="3" placeholder="Pl: Liszt, Cukor, Toj√°s" class="w-full p-2 border border-gray-300 rounded">${recipe.ingredients}</textarea>
                </div>
                
                <div>
                    <label for="recipe-optional" class="block text-sm font-medium text-moss-dark mb-1">Opcion√°lis √∂sszetev≈ëk (vessz≈ëvel elv√°lasztva):</label>
                    <textarea id="recipe-optional" rows="2" placeholder="Pl: Tejsz√≠n, Mogyor√≥" class="w-full p-2 border border-gray-300 rounded">${recipe.optionalIngredients}</textarea>
                </div>

                <div>
                    <label for="recipe-instructions" class="block text-sm font-medium text-moss-dark mb-1">Elk√©sz√≠t√©si √∫tmutat√≥:</label>
                    <textarea id="recipe-instructions" rows="5" placeholder="L√©p√©sr≈ël l√©p√©sre..." class="w-full p-2 border border-gray-300 rounded">${recipe.instructions}</textarea>
                </div>

                <div>
                    <label for="recipe-tags" class="block text-sm font-medium text-moss-dark mb-1">Tag-ek (vessz≈ëvel elv√°lasztva, pl: eb√©d, gyors, olasz):</label>
                    <input type="text" id="recipe-tags" placeholder="Pl: desszert, magyar, kar√°csony" value="${recipe.tags}" class="w-full p-2 border border-gray-300 rounded">
                </div>
            </div>
        `;

        const deleteButton = recipe.id ? `<button onclick="window.deleteRecipe('${recipe.id}'); window.closeModal('${modalId}');" class="text-red-500 hover:text-red-700 font-bold py-2 px-4 rounded transition duration-150 mr-4">T√∂rl√©s</button>` : '';
        
        const footer = `
            ${deleteButton}
            <button onclick="handleRecipeSubmit()" class="bg-leaf hover:bg-moss-light text-white font-bold py-2 px-4 rounded transition duration-150">
                Ment√©s / Friss√≠t√©s
            </button>
        `;
        createModal(modalId, title, body, footer, 'max-w-3xl');
    }

    window.handleRecipeSubmit = function() {
        const id = document.getElementById('recipe-id').value.trim();
        const name = document.getElementById('recipe-name').value.trim();
        
        const ingredients = document.getElementById('recipe-ingredients').value
            .split(',')
            .map(i => i.trim())
            .filter(i => i);
           
        const optionalIngredients = document.getElementById('recipe-optional').value
            .split(',')
            .map(i => i.trim())
            .filter(i => i);
           
        const instructions = document.getElementById('recipe-instructions').value;
       
        // Tagek feldolgoz√°sa
        const tags = document.getElementById('recipe-tags').value
            .toLowerCase()
            .split(',')
            .map(t => t.trim())
            .filter(t => t);


        if (!name || ingredients.length === 0 || !instructions) {
            showAlert('A recept nev√©re, a k√∂telez≈ë √∂sszetev≈ëkre √©s az utas√≠t√°sokra sz√ºks√©g van!', 'error');
            return;
        }

        // Mivel a Flask backend√ºnk csak 'POST' met√≥dust kezel a hozz√°ad√°shoz √©s friss√≠t√©shez (√©s az ID-t a POST-ban figyelmen k√≠v√ºl hagyja),
        // az id-t csak a t√∂rl√©sn√©l haszn√°ln√°nk. √öj elem eset√©n egyszer≈±en POST-olunk, √©s a backend gener√°l ID-t.
        // A friss√≠t√©s funkci√≥t most az egyszer≈±s√©g kedv√©√©rt egy √∫j bejegyz√©s hozz√°ad√°s√°ra cser√©lem, ami nem a legtiszt√°bb,
        // de az add-on koncepci√≥hoz gyorsabb. Jelen esetben a Home Assistant add-onban a szerkeszt√©shez egy √∫j POST-ot h√≠vunk meg, majd a r√©git t√∂r√∂lj√ºk.
        // A legjobb lenne egy PUT/PATCH v√©gpont az app.py-ban, de most marad a Firestore-hoz hasonl√≥ logik√°n√°l: 
        // 1. T√∂r√∂lj√ºk a r√©git
        // 2. L√©trehozzuk az √∫jat
        
        if (id) {
            // Szerkeszt√©s (r√©gi t√∂rl√©se, √∫j felvitele)
            window.deleteRecipe(id);
        }

        // L√©trehozzuk az √∫j (vagy friss√≠tett) receptet
        window.addRecipe(name, ingredients, optionalIngredients, instructions, tags);
        window.closeModal('recipe-modal');
    };

    // --- Recept sz≈±r≈ëk ---
    
    window.toggleCookableFilter = function() {
        recipeFilters.isCookableFilterActive = !recipeFilters.isCookableFilterActive;
        renderRecipes();
    };

    window.toggleTagFilter = function(tag) {
        if (recipeFilters.activeTags.has(tag)) {
            recipeFilters.activeTags.delete(tag);
        } else {
            recipeFilters.activeTags.add(tag);
        }
        renderRecipes();
    };


    // Kezdeti megjelen√≠t√©s (Az adatbet√∂lt√©s kezdem√©nyez√©se)
    window.addEventListener('load', () => {
        loadAndRenderData();
    });

</script>
</body>
</html>

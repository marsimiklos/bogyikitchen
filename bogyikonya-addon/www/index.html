<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mohakonyha - Konyhai Nyilv√°ntart√≥ (Lok√°lis HA API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Egyedi mohaz√∂ld paletta defini√°l√°sa */
        :root {
            --color-moss-dark: #4D6232; /* M√©ly mohaz√∂ld - gombok, f√≥kusz */
            --color-moss-light: #78A059; /* Vil√°gos mohaz√∂ld - akcentus */
            --color-background: #F8F8F4; /* T√∂rtfeh√©r h√°tt√©r */
            --color-expired: #B22222; /* T≈±zpiros */
            --color-warning: #FFD700; /* Arany - Lej√°rat k√∂zeli */
        }
        .bg-moss-dark { background-color: var(--color-moss-dark); }
        .text-moss-dark { color: var(--color-moss-dark); }
        .border-moss-dark { border-color: var(--color-moss-dark); }
        .bg-moss-light { background-color: var(--color-moss-light); }
        .text-moss-light { color: var(--color-moss-light); }


        /* Scrollbar styling for a cleaner look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb {
            background: var(--color-moss-light);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track { background: var(--color-background); }
    </style>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col font-sans">


    <div id="app" class="flex flex-col flex-grow max-w-4xl mx-auto w-full p-4 sm:p-6 lg:p-8">
       
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-moss-dark">Mohakonyha üåø</h1>
            <p id="auth-info" class="text-xs text-gray-500 mt-1">Helyi M√≥d (Lok√°lis API-t haszn√°l)...</p>
        </header>


        <div id="modal-container"></div>
        <div id="alert-container" class="fixed top-4 right-4 z-50"></div>


        <nav class="flex justify-between bg-white p-1 rounded-xl shadow-md mb-6 border border-moss-light">
            <button data-tab="preparedMeals" class="tab-btn active-tab flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200 bg-moss-dark text-white">K√©sz√©telek</button>
            <button data-tab="pantry" class="tab-btn flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200 text-moss-dark">Kamra</button>
            <button data-tab="shoppingList" class="tab-btn flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200 text-moss-dark">Bev√°s√°rl√≥lista</button>
            <button data-tab="recipes" class="tab-btn flex-1 py-3 text-sm font-semibold text-center rounded-lg transition-colors duration-200 text-moss-dark">Receptesk√∂nyv</button>
        </nav>


        <main id="tab-content" class="flex-grow bg-white p-4 sm:p-6 rounded-xl shadow-md overflow-y-auto">
            <p class="text-center text-gray-500 py-10">Bet√∂lt√©s...</p>
        </main>


    </div>


<script type="module">
    // --- LOK√ÅLIS API ALAPBE√ÅLL√çT√ÅSOK (JAV√çTOTT INGRESS KEZEL√âS) ---
    
    // Az Ingress Base Path lek√©r√©se, vagy alap√©rtelmezettk√©nt '/' haszn√°lata.
    // Pl: /api/hassio_addons/bogyikonya/ingress/

        // --- LOK√ÅLIS API ALAPBE√ÅLL√çT√ÅSOK (INGRESS JAV√çTVA) ---
    
    // 1. Megpr√≥b√°ljuk haszn√°lni a Python √°ltal injekt√°lt HASS_API_BASE_PATH-t
    // --- LOK√ÅLIS API ALAPBE√ÅLL√çT√ÅSOK (INGRESS K√âNYSZER√çTETT JAV√çT√ÅSA) ---
        
    // Injekt√°lt HASS_API_BASE_PATH vagy location.pathname fallback, mindig r√∂gz√≠tett form√°tum

    // API base path mindig egy perjellel kapcsolva
    let LOCAL_API_BASE = window.HASS_API_BASE_PATH.replace(/\/$/, "") + "/api";



    

    

    let userId = 'local_user'; // A felhaszn√°l√≥ ID a lok√°lis m√≥dban irrelev√°ns, de megtartva a strukt√∫ra miatt
    let isAuthReady = true; // Lok√°lis m√≥dban azonnal k√©sz a hiteles√≠t√©s
    let currentTab = 'preparedMeals';


    // Lok√°lis adatt√°rol√°s
    let state = {
        preparedMeals: [],
        pantry: [],
        shoppingList: [],
        recipes: [],
        pantryNames: new Set(), // Gyors keres√©shez, kisbet≈±s√≠tve
    };


    
    // Seg√©f√ºggv√©ny: API H√≠v√°sok kezel√©se 
    async function apiCall(endpoint, method = 'GET', data = null) {
        // A v√©gpont most m√°r tartalmazza az esetleges Ingress √∫tvonalat is.
        const url = `${LOCAL_API_BASE}/${endpoint}`;
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            }
        };


        if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(url, options);
            
            if (!response.ok) {
                // A KRITIKUS HIBA figyel√©se, k√ºl√∂n√∂sen a 404 (nem tal√°lhat√≥) miatt.
                throw new Error(`API hiba: ${response.status} ${response.statusText} a(z) ${url} c√≠men. Ellen≈ërizd a lok√°lis szervert!`);
            }
            
            // A 204 No Content v√°lasz a DELETE h√≠v√°skor szok√°sos, ilyenkor nincs JSON v√°lasz
            if (response.status === 204) return null; 
            
            return await response.json();
        } catch (e) {
            console.error(`Kritikus hiba a lok√°lis API h√≠v√°sakor: ${url}`, e);
            showAlert('KRITIKUS HIBA: Nem siker√ºlt a helyi API-hoz csatlakozni. Ellen≈ërizd, hogy fut-e a szerver!', 'error');
            throw e; 
        }
    }

    // A r√©gi getUserCollectionRef hely√©re a lok√°lis v√©gpontok nevei ker√ºlnek:
    const getLocalEndpoint = (collectionName) => {
        return collectionName; 
    };
    
    // Helyettes√≠t≈ë a Firebase serverTimestamp helyett
    const serverTimestamp = () => new Date(); 


    // Seg√©f√ºggv√©ny: D√°tum form√°z√°sa
    const formatDate = (timestamp) => {
        if (!timestamp) return 'N/A';
        // A lok√°lis API val√≥sz√≠n≈±leg ISO stringet ad vissza
        const date = timestamp instanceof Date ? timestamp : new Date(timestamp); 
        return date.toLocaleDateString('hu-HU', { year: 'numeric', month: 'short', day: 'numeric' });
    };


    // Seg√©df√ºggv√©ny: Alert √ºzenet megjelen√≠t√©se
    function showAlert(message, type = 'success') {
        const container = document.getElementById('alert-container');
       
        let color;


        if (type === 'error') {
            color = 'bg-red-500';
        } else {
            color = 'bg-moss-light';
        }


        const alertDiv = document.createElement('div');
        alertDiv.className = `p-4 mb-2 rounded-lg shadow-xl text-white max-w-sm ${color} transition-opacity duration-300 opacity-0`;
       
        alertDiv.innerHTML = `<span class="font-semibold">${message}</span>`;
       
        container.appendChild(alertDiv);
       
        // Anim√°ci√≥
        setTimeout(() => alertDiv.classList.remove('opacity-0'), 10);
        setTimeout(() => {
            alertDiv.classList.add('opacity-0');
            alertDiv.addEventListener('transitionend', () => alertDiv.remove());
        }, 3000);
    }


    // --- ADATBET√ñLT√âS √âS FRISS√çT√âS (A Real-time listenerek helyett) ---
    async function setupLocalDataLoad(tabToRefresh = null) {
        try {
            if (tabToRefresh === 'preparedMeals' || !tabToRefresh) {
                state.preparedMeals = await apiCall(getLocalEndpoint('preparedMeals'));
                // Rendez√©s a friss√≠t√©s ut√°n
                if (currentTab === 'preparedMeals') renderPreparedMeals();
            }

            if (tabToRefresh === 'pantry' || !tabToRefresh) {
                const pantryData = await apiCall(getLocalEndpoint('pantry'));
                // Ne felejtsd el a n√©v kisbet≈±s√≠t√©s√©t a gyors keres√©shez!
                state.pantry = pantryData.map(item => ({ id: item.id, ...item, name: item.name.toLowerCase().trim() }));
                state.pantryNames = new Set(state.pantry.map(item => item.name)); 
                if (currentTab === 'pantry') renderPantry();
                if (currentTab === 'recipes') renderRecipes(); // Recept stock friss√≠t√©se
            }

            if (tabToRefresh === 'shoppingList' || !tabToRefresh) {
                state.shoppingList = await apiCall(getLocalEndpoint('shoppingList'));
                if (currentTab === 'shoppingList') renderShoppingList();
            }

            if (tabToRefresh === 'recipes' || !tabToRefresh) {
                state.recipes = await apiCall(getLocalEndpoint('recipes'));
                if (currentTab === 'recipes') renderRecipes();
            }
            
        } catch (e) {
            // A hiba m√°r lekezelve az apiCall-ban
        }
    }


    // --- CRUD M≈±veletek (A Firebase addDoc/deleteDoc helyett apiCall) ---


    // K√©sz√©telek (Prepared Meals)
    window.addPreparedMeal = async function(name, expiryDate, requiresSide) {
        try {
            await apiCall(getLocalEndpoint('preparedMeals'), 'POST', {
                name,
                // D√°tum stringk√©nt t√°rolva
                expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null, 
                requiresSide,
                createdAt: serverTimestamp().toISOString()
            });
            showAlert('K√©sz√©tel sikeresen hozz√°adva a helyi API-n kereszt√ºl!');
            await setupLocalDataLoad('preparedMeals');
        } catch (e) {
            // ... hiba
        }
    }


    // K√©sz√©tel t√∂rl√©se/elfogyaszt√°sa 
    window.deletePreparedMeal = async function(id) {
        try {
            await apiCall(`${getLocalEndpoint('preparedMeals')}/${id}`, 'DELETE');
            showAlert('Elfogyasztva!');
            await setupLocalDataLoad('preparedMeals');
        } catch (e) {
            // ... hiba
        }
    }


    // Kamra (Pantry)
    window.addPantryItem = async function(name, expiryDate, shouldRestock, showAlertOnSuccess = true) {
        try {
            await apiCall(getLocalEndpoint('pantry'), 'POST', {
                name: name.trim(),
                expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null,
                shouldRestock,
                createdAt: serverTimestamp().toISOString()
            });
            if (showAlertOnSuccess) {
                showAlert('Kamra t√©tel sikeresen hozz√°adva a helyi API-n kereszt√ºl!');
            }
            await setupLocalDataLoad('pantry');
        } catch (e) {
            // ... hiba
        }
    }


    // Kamra t√©tel elfogyott/t√∂rl√©se -> Bev√°s√°rl√≥list√°ra ker√ºl 
    window.markPantryItemUsedUp = async function(id, name, shouldRestock) {
        try {
            // 1. T√∂rl√©s a kamr√°b√≥l
            await apiCall(`${getLocalEndpoint('pantry')}/${id}`, 'DELETE');
            
            // 2. √öjrav√°s√°rl√°s hozz√°ad√°sa a list√°hoz
            if (shouldRestock) {
                await apiCall(getLocalEndpoint('shoppingList'), 'POST', {
                    name,
                    isBought: false,
                    createdAt: serverTimestamp().toISOString(),
                    source: 'pantry_restock'
                });
                showAlert(`${name} elfogyott √©s automatikusan hozz√°adva a Bev√°s√°rl√≥list√°hoz!`);
                await setupLocalDataLoad('shoppingList'); // Friss√≠tsd a bev√°s√°rl√≥list√°t
            } else {
                showAlert(`${name} elfogyott!`);
            }
            
            await setupLocalDataLoad('pantry'); // Friss√≠tsd a kamr√°t
        } catch (e) {
            // ... hiba
        }
    }


    // Bev√°s√°rl√≥lista
    window.addShoppingListItem = async function(name) {
        try {
            await apiCall(getLocalEndpoint('shoppingList'), 'POST', {
                name: name.trim(),
                isBought: false,
                createdAt: serverTimestamp().toISOString(),
                source: 'manual'
            });
            showAlert(`${name} hozz√°adva a Bev√°s√°rl√≥list√°hoz!`);
            await setupLocalDataLoad('shoppingList');
        } catch (e) {
            // ... hiba
        }
    }
   
    window.deleteShoppingListItem = async function(id, showAlertOnSuccess = true) {
        try {
            await apiCall(`${getLocalEndpoint('shoppingList')}/${id}`, 'DELETE');
            if (showAlertOnSuccess) {
                showAlert('T√©tel t√∂r√∂lve a Bev√°s√°rl√≥list√°r√≥l!');
            }
            await setupLocalDataLoad('shoppingList');
        } catch (e) {
            // ... hiba
        }
    }


    // Receptesk√∂nyv
    window.addRecipe = async function(name, ingredients, optionalIngredients, instructions, tags) {
        try {
            await apiCall(getLocalEndpoint('recipes'), 'POST', {
                name: name.trim(),
                ingredients, // Array of strings
                optionalIngredients, // Array of strings
                instructions,
                tags, // Array of strings
                createdAt: serverTimestamp().toISOString()
            });
            showAlert(`${name} recept sikeresen hozz√°adva!`);
            await setupLocalDataLoad('recipes');
        } catch (e) {
            // ... hiba
        }
    }


    window.deleteRecipe = async function(id) {
        try {
            await apiCall(`${getLocalEndpoint('recipes')}/${id}`, 'DELETE');
            showAlert('Recept t√∂r√∂lve!');
            await setupLocalDataLoad('recipes');
        } catch (e) {
            // ... hiba
        }
    }
    
    // FIREBASE DEMO ADATOK BLOKKJA T√ñR√ñLVE.


    // --- UI/RENDER F√úGGV√âNYEK ---


    // D√°tum √°llapot jelz≈ë
    function getExpiryStatus(expiryDate) {
        // Fontos: a timestamp most ISO string, nem Date vagy Firebase Timestamp
        if (!expiryDate) return { color: 'text-gray-500', label: 'N/A' };
        
        // Konvert√°l√°s Date objektumm√° a sz√°m√≠t√°shoz
        const date = new Date(expiryDate);
        const diffDays = Math.ceil((date.getTime() - Date.now()) / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return { color: 'bg-red-500 text-white', label: 'LEJ√ÅRT!' };
        if (diffDays <= 3) return { color: 'bg-yellow-400 text-gray-800', label: `Lej√°rt: ${diffDays} nap` };
        return { color: 'text-gray-500', label: `${diffDays} nap` };
    }


    // Tab v√°lt√≥ logika
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            currentTab = button.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-moss-dark', 'text-white');
                btn.classList.add('text-moss-dark');
            });
            button.classList.add('bg-moss-dark', 'text-white');
            button.classList.remove('text-moss-dark');
            switchTab(currentTab);
        });
    });


    function switchTab(tab) {
        const contentDiv = document.getElementById('tab-content');
        if (!isAuthReady) {
            contentDiv.innerHTML = '<p class="text-center text-gray-500 py-10">K√©rlek v√°rj, az alkalmaz√°s bet√∂lti a helyi m√≥dot...</p>';
            return;
        }


        switch (tab) {
            case 'preparedMeals': renderPreparedMeals(); break;
            case 'pantry': renderPantry(); break;
            case 'shoppingList': renderShoppingList(); break;
            case 'recipes': renderRecipes(); break;
        }
    }


    // --- 1. K√âSZ√âTELEK RENDEREL√âSE ---
    function renderPreparedMeals() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';
       
        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-moss-dark">Fagyaszt√≥/H≈±t≈ë Tartalom</h2>
                <button onclick="window.showPreparedMealModal()" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                    + √öj K√©sz√©tel
                </button>
            </div>
            <div id="prepared-meals-list" class="space-y-3">
                ${state.preparedMeals.length === 0 ? '<p class="text-center text-gray-500 py-10">Nincsenek r√∂gz√≠tett k√©sz√©telek. Add hozz√° az els≈ët!</p>' : ''}
            </div>
        `;
       
        const listDiv = document.getElementById('prepared-meals-list');
        // Rendez√©s lej√°rat szerint (legr√©gebbi el≈ël)
        const sortedMeals = [...state.preparedMeals].sort((a, b) => {
            const dateA = a.expiryDate ? new Date(a.expiryDate).getTime() : Infinity;
            const dateB = b.expiryDate ? new Date(b.expiryDate).getTime() : Infinity;
            return dateA - dateB;
        });


        sortedMeals.forEach(meal => {
            const status = getExpiryStatus(meal.expiryDate);
            listDiv.innerHTML += `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="flex-grow">
                        <p class="font-semibold text-moss-dark">${meal.name}</p>
                        <p class="text-xs text-gray-600">
                            Lej√°rati d√°tum: <span class="font-medium ${status.color === 'text-gray-500' ? 'text-gray-500' : 'px-2 py-0.5 rounded-full ' + status.color}">${formatDate(meal.expiryDate)} (${status.label})</span>
                        </p>
                        <p class="text-xs ${meal.requiresSide ? 'text-red-500' : 'text-moss-light'}">
                            K√∂ret sz√ºks√©ges: <span class="font-bold">${meal.requiresSide ? 'IGEN' : 'NEM'}</span>
                        </p>
                    </div>
                    <button onclick="window.deletePreparedMeal('${meal.id}')" class="ml-4 bg-moss-dark text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-moss-light transition-colors">
                        Elfogyasztva
                    </button>
                </div>
            `;
        });
    }
   
    // Modal a k√©sz√©telek bevitel√©hez (Glob√°lis)
    window.showPreparedMealModal = () => {
        if (!isAuthReady) {
            showAlert('Az alkalmaz√°s m√©g t√∂lt. K√©rlek v√°rj!', 'error');
            return;
        }
        const today = new Date().toISOString().split('T')[0];
        const modalHtml = `
            <div id="pm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 class="text-xl font-bold text-moss-dark mb-4">√öj K√©sz√©tel R√∂gz√≠t√©se</h3>
                    <form onsubmit="window.handlePreparedMealSubmit(event)">
                        <div class="mb-4">
                            <label for="pm-name" class="block text-sm font-medium text-gray-700">N√©v</label>
                            <input type="text" id="pm-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="mb-4">
                            <label for="pm-expiry" class="block text-sm font-medium text-gray-700">Lej√°rati D√°tum</label>
                            <input type="date" id="pm-expiry" value="${today}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="mb-6 flex items-center">
                            <input type="checkbox" id="pm-side" class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                            <label for="pm-side" class="ml-2 block text-sm text-gray-700">Kell hozz√° k√∂ret?</label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="window.closeModal('pm-modal')" class="px-4 py-2 text-sm font-semibold text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">M√©gsem</button>
                            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-moss-dark rounded-lg shadow hover:bg-moss-light transition-colors">Ment√©s</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;
    };


    // Modal submit handler (Glob√°lis)
    window.handlePreparedMealSubmit = (event) => {
        event.preventDefault();
        const name = document.getElementById('pm-name').value;
        const expiry = document.getElementById('pm-expiry').value;
        const side = document.getElementById('pm-side').checked;
        window.addPreparedMeal(name, expiry, side);
        window.closeModal('pm-modal');
    };
   
    // --- 2. KAMRA RENDEREL√âSE ---
    function renderPantry() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';


        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-moss-dark">Kamra Tartalom (Hozz√°val√≥k)</h2>
                <button onclick="window.showPantryModal()" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                    + √öj Kamra T√©tel
                </button>
            </div>
            <div id="pantry-list" class="space-y-3">
                ${state.pantry.length === 0 ? '<p class="text-center text-gray-500 py-10">A kamra √ºres. Kezdj√ºk a felt√∂lt√©st!</p>' : ''}
            </div>
        `;
       
        const listDiv = document.getElementById('pantry-list');
        // Rendez√©s lej√°rat szerint
        const sortedPantry = [...state.pantry].sort((a, b) => {
            const dateA = a.expiryDate ? new Date(a.expiryDate).getTime() : Infinity;
            const dateB = b.expiryDate ? new Date(b.expiryDate).getTime() : Infinity;
            return dateA - dateB;
        });


        sortedPantry.forEach(item => {
            const nameCapitalized = item.name.charAt(0).toUpperCase() + item.name.slice(1);
            const status = getExpiryStatus(item.expiryDate);
            listDiv.innerHTML += `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="flex-grow">
                        <p class="font-semibold text-moss-dark">${nameCapitalized}</p>
                        <p class="text-xs text-gray-600">
                            Lej√°rati d√°tum: <span class="font-medium ${status.color === 'text-gray-500' ? 'text-gray-500' : 'px-2 py-0.5 rounded-full ' + status.color}">${formatDate(item.expiryDate)} (${status.label})</span>
                        </p>
                        <p class="text-xs ${item.shouldRestock ? 'text-moss-dark' : 'text-gray-500'}">
                            √öjrav√°s√°roland√≥ (Staple): <span class="font-bold">${item.shouldRestock ? 'IGEN' : 'NEM'}</span>
                        </p>
                    </div>
                    <button onclick="window.markPantryItemUsedUp('${item.id}', '${nameCapitalized}', ${item.shouldRestock})" class="ml-4 bg-red-500 text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-red-600 transition-colors">
                        Elfogyott
                    </button>
                </div>
            `;
        });
    }


    // Modal a kamra bevitel√©hez (Manu√°lis vagy Bev√°s√°rl√≥list√°r√≥l) (Glob√°lis)
    window.showPantryModal = (shoppingItemId = null, prefilledName = '') => {
         if (!isAuthReady) {
            showAlert('Az alkalmaz√°s m√©g t√∂lt. K√©rlek v√°rj!', 'error');
            return;
        }
        const today = new Date().toISOString().split('T')[0];
        const modalHtml = `
            <div id="pantry-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                    <h3 class="text-xl font-bold text-moss-dark mb-4">${shoppingItemId ? 'Megv√°s√°rolva - Kamr√°ba Ment√©s' : '√öj Kamra T√©tel R√∂gz√≠t√©se'}</h3>
                    <form onsubmit="window.handlePantrySubmit(event, '${shoppingItemId}', '${prefilledName}')">
                        <div class="mb-4">
                            <label for="pantry-name" class="block text-sm font-medium text-gray-700">N√©v</label>
                            <input type="text" id="pantry-name" value="${prefilledName}" ${prefilledName ? 'readonly' : 'required'} class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2 ${prefilledName ? 'bg-gray-100' : ''}">
                        </div>
                        <div class="mb-4">
                            <label for="pantry-expiry" class="block text-sm font-medium text-gray-700">Lej√°rati D√°tum</label>
                            <input type="date" id="pantry-expiry" value="${today}" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="mb-6 flex items-center">
                            <input type="checkbox" id="pantry-restock" checked class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                            <label for="pantry-restock" class="ml-2 block text-sm text-gray-700">Alapvet≈ë √©lelmiszer (√öjrav√°s√°roland√≥)</label>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="window.closeModal('pantry-modal')" class="px-4 py-2 text-sm font-semibold text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">M√©gsem</button>
                            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-moss-dark rounded-lg shadow hover:bg-moss-light transition-colors">Ment√©s √©s R√∂gz√≠t√©s</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;
    };


    // Modal submit handler (Glob√°lis)
    window.handlePantrySubmit = async function(event, shoppingItemId, prefilledName) {
        event.preventDefault();
        const name = prefilledName || document.getElementById('pantry-name').value;
        const expiry = document.getElementById('pantry-expiry').value;
        const restock = document.getElementById('pantry-restock').checked;
       
        if (shoppingItemId && prefilledName) {
            // Bev√°s√°rl√≥list√°r√≥l j√∂tt
            await window.addPantryItem(name, expiry, restock, false);
            await window.deleteShoppingListItem(shoppingItemId, false); 
           
            showAlert(`Sikeresen megv√°s√°rolva √©s hozz√°adva a kamr√°hoz!`);
        } else {
            // Manu√°lis kamra bevitel
            window.addPantryItem(name, expiry, restock);
        }
        window.closeModal('pantry-modal');
    };


    // --- 3. BEV√ÅS√ÅRL√ìLISTA RENDEREL√âSE ---
    function renderShoppingList() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';


        contentDiv.innerHTML = `
            <div class="flex flex-col mb-4 space-y-3">
                <h2 class="text-xl font-bold text-moss-dark">Bev√°s√°rl√≥lista</h2>
                <form onsubmit="window.handleNewShoppingItem(event)" class="flex space-x-2">
                    <input type="text" id="new-shopping-item" placeholder="√öj t√©tel hozz√°ad√°sa..." required class="flex-grow rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                    <button type="submit" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                        Hozz√°ad
                    </button>
                </form>
            </div>
            <div id="shopping-list-items" class="space-y-3">
                ${state.shoppingList.length === 0 ? '<p class="text-center text-gray-500 py-10">A bev√°s√°rl√≥lista √ºres! Vagy vedd meg a t√©teleket, vagy jel√∂lj el egy kamra alapanyagot elfogyottnak!</p>' : ''}
            </div>
        `;
       
        const listDiv = document.getElementById('shopping-list-items');
        state.shoppingList.forEach(item => {
            listDiv.innerHTML += `
                <div class="flex items-center bg-gray-50 p-3 rounded-lg border border-gray-200 justify-between">
                    <p class="font-medium text-gray-700 ${item.source === 'pantry_restock' ? 'italic' : ''}">${item.name}</p>
                    <div class="flex space-x-2">
                        <button onclick="window.showPantryModal('${item.id}', '${item.name}')" class="bg-moss-light text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-moss-dark transition-colors">
                            Megv√°s√°rolva
                        </button>
                        <button onclick="window.deleteShoppingListItem('${item.id}')" class="bg-gray-400 text-white text-xs px-3 py-1 rounded-full shadow-md hover:bg-gray-500 transition-colors">
                            T√∂r√∂l
                        </button>
                    </div>
                </div>
            `;
        });
    }


    // Bev√°s√°rl√≥ t√©tel kezel≈ë (Glob√°lis)
    window.handleNewShoppingItem = (event) => {
        event.preventDefault();
        const input = document.getElementById('new-shopping-item');
        window.addShoppingListItem(input.value);
        input.value = '';
    };


    // --- 4. RECEPTESK√ñNYV RENDEREL√âSE ---
    let recipeFilters = {
        hasAllIngredients: false,
        selectedTags: new Set(),
        allAvailableTags: new Set(),
    };


    function renderRecipes() {
        const contentDiv = document.getElementById('tab-content');
        const isDisabled = !isAuthReady ? 'disabled' : '';
       
        // √ñsszes tag √∂sszegy≈±jt√©se
        state.recipes.forEach(r => r.tags.forEach(tag => recipeFilters.allAvailableTags.add(tag)));
       
        // Sz≈±r√©si logik√°t seg√≠t≈ë funkci√≥
        const isIngredientInStock = (ingredientName) => {
            return state.pantryNames.has(ingredientName.toLowerCase().trim());
        };


        const isRecipeCookable = (recipe) => {
            return recipe.ingredients.every(isIngredientInStock);
        };


        // Tag sz≈±r≈ëk renderel√©se
        const tagFilterHtml = Array.from(recipeFilters.allAvailableTags).map(tag => {
            const isSelected = recipeFilters.selectedTags.has(tag);
            return `
                <button onclick="window.toggleTagFilter('${tag}')" class="text-xs px-3 py-1 rounded-full border transition-colors duration-200 ${
                    isSelected ? 'bg-moss-dark text-white border-moss-dark' : 'bg-white text-moss-dark border-moss-dark hover:bg-moss-light hover:text-white'
                }">
                    #${tag}
                </button>
            `;
        }).join('');


        contentDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-moss-dark">Receptesk√∂nyv </h2>
                <button onclick="window.showRecipeModal()" ${isDisabled} class="bg-moss-dark text-white text-sm px-4 py-2 rounded-lg shadow hover:bg-moss-light transition-colors ${isDisabled ? 'opacity-50 cursor-not-allowed' : ''}">
                    + √öj Recept
                </button>
            </div>
           
            <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-moss-light/50">
                <h3 class="font-semibold text-moss-dark mb-3">Sz≈±r≈ëk:</h3>
               
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="filter-cookable" ${recipeFilters.hasAllIngredients ? 'checked' : ''} onchange="window.toggleCookableFilter(this.checked)" class="h-4 w-4 text-moss-dark border-gray-300 rounded focus:ring-moss-dark">
                    <label for="filter-cookable" class="ml-2 block text-sm font-medium text-gray-700">
                        Csak azokat, amikhez MINDEN van otthon (f≈ë hozz√°val√≥)
                    </label>
                </div>
               
                <div class="flex flex-wrap gap-2">
                    ${tagFilterHtml}
                </div>
            </div>


            <div id="recipes-list" class="space-y-4">
               
            </div>
        `;
       
        const listDiv = document.getElementById('recipes-list');
       
        // Sz≈±r√©s alkalmaz√°sa
        let filteredRecipes = state.recipes.filter(recipe => {
            // 1. "Minden van otthon" sz≈±r≈ë
            if (recipeFilters.hasAllIngredients && !isRecipeCookable(recipe)) {
                return false;
            }
            // 2. Tag sz≈±r≈ë
            if (recipeFilters.selectedTags.size > 0) {
                const recipeTags = new Set(recipe.tags);
                return Array.from(recipeFilters.selectedTags).every(tag => recipeTags.has(tag));
            }
            return true;
        });
       
        if (filteredRecipes.length === 0) {
            listDiv.innerHTML = '<p class="text-center text-gray-500 py-10">Nincs a sz≈±r≈ëknek megfelel≈ë recept.</p>';
        }


        filteredRecipes.forEach(recipe => {
            // Hozz√°val√≥k list√°ja (Stock jelz≈ëvel)
            const allIngredientsHtml = [
                ...recipe.ingredients.map(i => ({ name: i, optional: false })),
                ...recipe.optionalIngredients.map(i => ({ name: i, optional: true }))
            ].map(item => {
                const stock = isIngredientInStock(item.name);
                const color = stock ? 'bg-moss-light' : 'bg-red-500';
                const status = stock ? 'K√©szleten' : 'Hi√°nyzik';
                return `
                    <li class="flex items-center text-sm text-gray-700">
                        <span class="w-2 h-2 rounded-full mr-2 ${color} flex-shrink-0" title="${status}"></span>
                        ${item.name} ${item.optional ? '<span class="text-xs italic text-gray-500">(opcion√°lis)</span>' : ''}
                    </li>
                `;
            }).join('');


            listDiv.innerHTML += `
                <div class="bg-white p-5 rounded-xl shadow-lg border border-moss-light/30">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-moss-dark mb-2">${recipe.name}</h3>
                        <button onclick="window.deleteRecipe('${recipe.id}')" class="text-red-400 hover:text-red-600 transition-colors text-sm ml-4">
                            T√∂rl√©s
                        </button>
                    </div>
                   
                    <div class="flex flex-wrap gap-1 mb-3">
                        ${recipe.tags.map(tag => `<span class="text-xs bg-moss-dark/10 text-moss-dark px-2 py-0.5 rounded-full">${tag}</span>`).join('')}
                    </div>


                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="font-semibold text-gray-700 mb-1">Hozz√°val√≥k:</p>
                            <ul class="list-none space-y-1 pl-0">
                                ${allIngredientsHtml}
                            </ul>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-1">Elk√©sz√≠t√©si Javaslat:</p>
                            <p class="text-sm text-gray-600">${recipe.instructions}</p>
                        </div>
                    </div>
                </div>
            `;
        });
    }


    // Recept sz≈±r≈ë (Glob√°lis)
    window.toggleCookableFilter = (checked) => {
        recipeFilters.hasAllIngredients = checked;
        renderRecipes();
    };


    // Recept tag sz≈±r≈ë (Glob√°lis)
    window.toggleTagFilter = (tag) => {
        if (recipeFilters.selectedTags.has(tag)) {
            recipeFilters.selectedTags.delete(tag);
        } else {
            recipeFilters.selectedTags.add(tag);
        }
        renderRecipes();
    };


    // Recept bevitel modal (Glob√°lis)
    window.showRecipeModal = (recipe = null) => {
         if (!isAuthReady) {
            showAlert('Az alkalmaz√°s m√©g t√∂lt. K√©rlek v√°rj!', 'error');
            return;
        }
        const modalHtml = `
            <div id="recipe-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto max-h-[90vh]">
                    <h3 class="text-xl font-bold text-moss-dark mb-4">√öj Recept R√∂gz√≠t√©se</h3>
                    <form onsubmit="window.handleRecipeSubmit(event)">
                        <div class="mb-4">
                            <label for="recipe-name" class="block text-sm font-medium text-gray-700">N√©v</label>
                            <input type="text" id="recipe-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="mb-4">
                            <label for="recipe-ingredients" class="block text-sm font-medium text-gray-700">F≈ë Hozz√°val√≥k (Vessz≈ëvel elv√°lasztva)</label>
                            <textarea id="recipe-ingredients" required rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="recipe-optional" class="block text-sm font-medium text-gray-700">Opcion√°lis Hozz√°val√≥k (Vessz≈ëvel elv√°lasztva)</label>
                            <textarea id="recipe-optional" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="recipe-instructions" class="block text-sm font-medium text-gray-700">Elk√©sz√≠t√©si Javaslat</label>
                            <textarea id="recipe-instructions" required rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2"></textarea>
                        </div>
                        <div class="mb-6">
                            <label for="recipe-tags" class="block text-sm font-medium text-gray-700">Tagek (Vessz≈ëvel elv√°lasztva, pl. olasz, sajtos)</label>
                            <input type="text" id="recipe-tags" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-moss-light focus:ring-moss-light border p-2">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="window.closeModal('recipe-modal')" class="px-4 py-2 text-sm font-semibold text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">M√©gsem</button>
                            <button type="submit" class="px-4 py-2 text-sm font-semibold text-white bg-moss-dark rounded-lg shadow hover:bg-moss-light transition-colors">Ment√©s</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('modal-container').innerHTML = modalHtml;
    };


    // Recept submit handler (Glob√°lis)
    window.handleRecipeSubmit = (event) => {
        event.preventDefault();
        const name = document.getElementById('recipe-name').value;
       
        // Hozz√°val√≥k feldolgoz√°sa (t√∂mb l√©trehoz√°sa √©s tiszt√≠t√°s)
        const ingredients = document.getElementById('recipe-ingredients').value
            .split(',')
            .map(i => i.trim())
            .filter(i => i);
           
        const optionalIngredients = document.getElementById('recipe-optional').value
            .split(',')
            .map(i => i.trim())
            .filter(i => i);
           
        const instructions = document.getElementById('recipe-instructions').value;
       
        // Tagek feldolgoz√°sa
        const tags = document.getElementById('recipe-tags').value
            .toLowerCase()
            .split(',')
            .map(t => t.trim())
            .filter(t => t);


        window.addRecipe(name, ingredients, optionalIngredients, instructions, tags);
        window.closeModal('recipe-modal');
    };


    // --- √Åltal√°nos Modal kezel≈ë (Glob√°lis) ---
    window.closeModal = (id) => {
        const modal = document.getElementById(id);
        if (modal) modal.remove();
        document.getElementById('modal-container').innerHTML = ''; // Biztos, ami biztos
    };
    
    // --- LOK√ÅLIS ALKALMAZ√ÅS IND√çT√ÅSA ---
    async function initLocalApp() {
        const apiPath = LOCAL_API_BASE; // M√°r a LOCAL_API_BASE tartalmazza a teljes, prefixelt √∫tvonalat.
        document.getElementById('auth-info').textContent = `Helyi M√≥d (API Base: ${apiPath})`;
       
        // Adatbet√∂lt√©s a helyi API-r√≥l
        await setupLocalDataLoad();
       
        // Els≈ë tab megjelen√≠t√©se
        switchTab(currentTab);
    }
    
    // Alkalmaz√°s ind√≠t√°sa a bet√∂lt√©s ut√°n
    window.addEventListener('load', () => {
        initLocalApp();
    });


</script>
</body>
</html>
